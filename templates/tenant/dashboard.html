{% extends "portal/base_portal.html" %}

{% block title %}{{ _('Dashboard') }} – {{ tenant.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col">
      <h1 class="h3 mb-1 d-flex align-items-center gap-2">
        {% if branding.logo_url %}
          <img src="{{ branding.logo_url }}" alt="tenant-logo" style="width:34px;height:34px;object-fit:cover;border-radius:.4rem;">
        {% else %}
          <i class="bi bi-building"></i>
        {% endif %}
        <span>{{ branding.nickname or tenant.name }}</span>
      </h1>
      <p class="text-muted">{{ _('Gérez votre compte, utilisateurs et abonnements') }}</p>
    </div>
    <div class="col-auto d-flex gap-2">
      {% if is_admin %}
      <a href="{{ url_for('tenant.prospects_agenda') }}" class="btn btn-outline-secondary">
        <i class="bi bi-calendar-week"></i> {{ _('Agenda RDV') }}
      </a>
      {% endif %}
      <a href="{{ url_for('tenant.profile') }}" class="btn btn-outline-primary">
        <i class="bi bi-person-circle"></i> {{ _('Mon profil') }}
      </a>
      <a href="{{ url_for('tenant.logout') }}" class="btn btn-outline-secondary">
        <i class="bi bi-box-arrow-right"></i> {{ _('Déconnexion') }}
      </a>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex align-items-center gap-3">
          {% if profile.avatar_mode == 'photo' and profile.photo_url %}
            <img src="{{ profile.photo_url }}" alt="profile" style="width:52px;height:52px;object-fit:cover;border-radius:50%;">
          {% else %}
            <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width:52px;height:52px;">
              <i class="bi bi-{{ profile.avatar_icon or 'person-circle' }} text-primary" style="font-size:1.4rem;"></i>
            </div>
          {% endif %}
          <div>
            <div class="fw-semibold">{{ profile.display_name or current_user.email }}</div>
            {% if profile.bio %}<div class="small text-secondary">{{ profile.bio }}</div>{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category in ['error','danger'] else ('success' if category=='success' else 'warning' if category=='warning' else 'info') }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Subscription Status Banner -->
  {% if subscription %}
  <div class="row mb-4">
    <div class="col">
      <div class="card border-0 shadow-sm {% if subscription.is_trial() %}bg-warning bg-opacity-10{% elif subscription.status == 'active' %}bg-success bg-opacity-10{% else %}bg-danger bg-opacity-10{% endif %}">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="mb-2">
                {% if subscription.is_trial() %}
                  <i class="bi bi-clock-history"></i> {{ _('Période d\'essai gratuite') }}
                {% elif subscription.status == 'active' %}
                  <i class="bi bi-check-circle"></i> {{ _('Abonnement actif') }}
                {% elif subscription.status == 'suspended' %}
                  <i class="bi bi-exclamation-triangle"></i> {{ _('Abonnement suspendu') }}
                {% else %}
                  <i class="bi bi-x-circle"></i> {{ _('Abonnement annulé') }}
                {% endif %}
                – {{ stats.plan_name }}
              </h5>
              <p class="mb-0">
                {% if subscription.is_trial() %}
                  {{ _('Il vous reste') }} <strong>{{ stats.trial_days_left }}</strong> {{ _('jours d\'essai gratuit') }}
                {% elif subscription.status == 'active' %}
                  {{ _('Votre abonnement est actif et à jour') }}
                {% endif %}
              </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
              <a href="{{ url_for('tenant.subscription') }}" class="btn btn-primary btn-sm">
                <i class="bi bi-gear"></i> {{ _('Gérer l\'abonnement') }}
              </a>
              {% if subscription.is_trial() %}
                <a href="{{ url_for('billing.plans') }}" class="btn btn-success btn-sm">
                  <i class="bi bi-rocket"></i> {{ _('Passer à la version payante') }}
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link active" href="#overview" data-bs-toggle="tab">
        <i class="bi bi-speedometer2"></i> {{ _('Vue d\'ensemble') }}
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#users" data-bs-toggle="tab">
        <i class="bi bi-people"></i> {{ _('Utilisateurs') }} ({{ users|length }})
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#products" data-bs-toggle="tab">
        <i class="bi bi-box-seam"></i> {{ _('Produits') }}
      </a>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview">
      <div class="row g-3">
        <!-- Usage Stats -->
        <div class="col-md-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h6 class="text-muted mb-3">
                <i class="bi bi-people"></i> {{ _('Utilisateurs') }}
              </h6>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="h3 mb-0">{{ stats.usage.users.current }}</div>
                <div class="text-muted">/ {{ stats.usage.users.max if stats.usage.users.max > 0 else '∞' }}</div>
              </div>
              <div class="progress" style="height: 8px;">
                {% set user_percent = (stats.usage.users.current / stats.usage.users.max * 100) if stats.usage.users.max > 0 else 0 %}
                <div class="progress-bar" style="width: {{ user_percent }}%"></div>
              </div>
              {% if is_admin %}
              <a href="{{ url_for('tenant.users') }}" class="btn btn-sm btn-outline-primary mt-3 w-100">
                {{ _('Gérer les utilisateurs') }}
              </a>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h6 class="text-muted mb-3">
                <i class="bi bi-building"></i> {{ _('Entreprises') }}
              </h6>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="h3 mb-0">{{ stats.usage.companies.current }}</div>
                <div class="text-muted">/ {{ stats.usage.companies.max if stats.usage.companies.max > 0 else '∞' }}</div>
              </div>
              <div class="progress" style="height: 8px;">
                {% set company_percent = (stats.usage.companies.current / stats.usage.companies.max * 100) if stats.usage.companies.max > 0 else 0 %}
                <div class="progress-bar bg-success" style="width: {{ company_percent }}%"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h6 class="text-muted mb-3">
                <i class="bi bi-arrow-left-right"></i> {{ _('Transactions ce mois') }}
              </h6>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="h3 mb-0">{{ stats.usage.transactions.current }}</div>
                <div class="text-muted">/ {{ stats.usage.transactions.max if stats.usage.transactions.max > 0 else '∞' }}</div>
              </div>
              <div class="progress" style="height: 8px;">
                {% set tx_percent = (stats.usage.transactions.current / stats.usage.transactions.max * 100) if stats.usage.transactions.max > 0 else 0 %}
                <div class="progress-bar bg-warning" style="width: {{ tx_percent }}%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Account Info -->
      <div class="row mt-4">
        <div class="col">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">{{ _('Informations du compte') }}</h5>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <strong>{{ _('Organisation:') }}</strong> {{ tenant.name }}
                  </div>
                  {% if branding.nickname %}
                  <div class="mb-3">
                    <strong>{{ _('Nickname:') }}</strong> {{ branding.nickname }}
                  </div>
                  {% endif %}
                  <div class="mb-3">
                    <strong>{{ _('Slug:') }}</strong> <code>{{ tenant.slug }}</code>
                  </div>
                  <div class="mb-3">
                    <strong>{{ _('Créé le:') }}</strong> {{ stats.created_at.strftime('%d/%m/%Y') }}
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <strong>{{ _('Plan:') }}</strong> 
                    <span class="badge bg-primary">{{ stats.plan_name }}</span>
                  </div>
                  <div class="mb-3">
                    <strong>{{ _('Modules:') }}</strong>
                    {% if stats.has_finance %}
                      <span class="badge bg-success">{{ _('Finance') }}</span>
                    {% endif %}
                    {% if stats.has_bi %}
                      <span class="badge bg-info">{{ _('BI') }}</span>
                    {% endif %}
                    {% if stats.has_project %}
                      <span class="badge bg-primary">{{ _('Projet') }}</span>
                    {% endif %}
                    {% if not stats.has_finance and not stats.has_bi and not stats.has_project %}
                      <span class="text-muted">{{ _('Aucun module actif') }}</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Tab -->
    <div class="tab-pane fade" id="users">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">{{ _('Utilisateurs') }}</h5>
            {% if is_admin %}
            <a href="{{ url_for('tenant.invite_user') }}" class="btn btn-primary btn-sm">
              <i class="bi bi-person-plus"></i> {{ _('Inviter un utilisateur') }}
            </a>
            {% endif %}
          </div>

          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>{{ _('Email') }}</th>
                  <th>{{ _('Rôles') }}</th>
                  <th>{{ _('Statut') }}</th>
                  <th>{{ _('Dernière connexion') }}</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr>
                  <td>{{ user.email }}</td>
                  <td>
                    {% for role in user.roles %}
                      <span class="badge bg-secondary">{{ role }}</span>
                    {% endfor %}
                  </td>
                  <td>
                    {% if user.status == 'active' %}
                      <span class="badge bg-success">{{ _('Actif') }}</span>
                    {% elif user.status == 'pending_verification' %}
                      <span class="badge bg-warning">{{ _('En attente') }}</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ user.status }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if user.last_login_at %}
                      {{ user.last_login_at.strftime('%d/%m/%Y %H:%M') }}
                    {% else %}
                      <span class="text-muted">{{ _('Jamais') }}</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Tab -->
    <div class="tab-pane fade" id="products">
      <div class="row g-3">
        {% if stats.has_finance or stats.plan_code == 'free' %}
        <div class="col-md-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">
                <i class="bi bi-cash-coin"></i> {{ _('AUDELA Finance') }}
              </h5>
              <p class="text-muted">{{ _('Gestion financière complète avec LCR, NSFR et synchronisation bancaire') }}</p>
              {% if stats.has_finance %}
              {% if module_access.finance %}
              <a href="{{ url_for('finance.dashboard') }}" class="btn btn-primary w-100">
                <i class="bi bi-box-arrow-up-right"></i> {{ _('Accéder à Finance') }}
              </a>
              {% else %}
              <button class="btn btn-outline-secondary w-100" disabled>
                <i class="bi bi-lock"></i> {{ _('Accès Finance désactivé') }}
              </button>
              {% endif %}
              {% elif stats.plan_code == 'free' %}
              {% if module_access.finance %}
              <a href="{{ url_for('finance.dashboard') }}" class="btn btn-primary w-100">
                <i class="bi bi-box-arrow-up-right"></i> {{ _('Découvrir Finance') }}
              </a>
              {% else %}
              <button class="btn btn-outline-secondary w-100" disabled>
                <i class="bi bi-lock"></i> {{ _('Accès Finance désactivé') }}
              </button>
              {% endif %}
              {% else %}
              <a href="{{ url_for('billing.plans', product='finance') }}" class="btn btn-outline-primary w-100">
                <i class="bi bi-rocket"></i> {{ _('Activer Finance') }}
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}

        {% if stats.has_bi or stats.plan_code == 'free' %}
        <div class="col-md-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">
                <i class="bi bi-graph-up"></i> {{ _('AUDELA BI') }}
              </h5>
              <p class="text-muted">{{ _('Business Intelligence et tableaux de bord') }}</p>
              {% if stats.has_bi %}
              {% if module_access.bi %}
              <a href="{{ url_for('portal.home', app_mode='bi') }}" class="btn btn-primary w-100">
                <i class="bi bi-box-arrow-up-right"></i> {{ _('Accéder à BI') }}
              </a>
              {% else %}
              <button class="btn btn-outline-secondary w-100" disabled>
                <i class="bi bi-lock"></i> {{ _('Accès BI désactivé') }}
              </button>
              {% endif %}
              {% elif stats.plan_code == 'free' %}
              {% if module_access.bi %}
              <a href="{{ url_for('portal.home', app_mode='bi') }}" class="btn btn-primary w-100">
                <i class="bi bi-box-arrow-up-right"></i> {{ _('Découvrir BI') }}
              </a>
              {% else %}
              <button class="btn btn-outline-secondary w-100" disabled>
                <i class="bi bi-lock"></i> {{ _('Accès BI désactivé') }}
              </button>
              {% endif %}
              {% else %}
              <a href="{{ url_for('billing.plans', product='bi') }}" class="btn btn-outline-primary w-100">
                <i class="bi bi-rocket"></i> {{ _('Activer BI') }}
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}

        {% if stats.has_project or stats.plan_code == 'free' %}
        <div class="col-md-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h5 class="mb-3">
                <i class="bi bi-kanban"></i> {{ _('AUDELA Project') }}
              </h5>
              <p class="text-muted">{{ _('Gestion de projet avec Kanban, Gantt, livrables et cérémonies Scrum/Agile') }}</p>
              {% if stats.has_project %}
              <a href="{{ url_for('project.dashboard') }}" class="btn btn-primary w-100">
                <i class="bi bi-box-arrow-up-right"></i> {{ _('Accéder à Projet') }}
              </a>
              {% elif stats.plan_code == 'free' %}
              <a href="{{ url_for('project.dashboard') }}" class="btn btn-primary w-100">
                <i class="bi bi-box-arrow-up-right"></i> {{ _('Découvrir Projet') }}
              </a>
              {% else %}
              <a href="{{ url_for('billing.plans', product='project') }}" class="btn btn-outline-primary w-100">
                <i class="bi bi-rocket"></i> {{ _('Activer Projet') }}
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}

        {% if not stats.has_finance and not stats.has_bi and not stats.has_project and stats.plan_code != 'free' %}
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
              <i class="bi bi-box-seam" style="font-size: 3rem; opacity: 0.3;"></i>
              <h5 class="mt-3">{{ _('Aucun produit actif') }}</h5>
              <p class="text-muted">{{ _('Abonnez-vous à Finance, BI ou Projet pour commencer') }}</p>
              <a href="{{ url_for('billing.plans') }}" class="btn btn-primary">
                <i class="bi bi-rocket"></i> {{ _('Voir les plans') }}
              </a>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
.nav-tabs .nav-link {
  color: #6c757d;
}
.nav-tabs .nav-link.active {
  color: #0d6efd;
  font-weight: 500;
}
</style>
{% endblock %}
