{% extends "portal/base_portal.html" %}

{% block title %}{% if title %}{{ title }} – {% endif %}{{ _('AUDELA Finance') }}{% endblock %}

{% block content %}
  <nav class="navbar navbar-expand-lg border-bottom bg-body sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold" href="{{ url_for('finance.dashboard') }}">
        <i class="bi bi-cash-coin me-1"></i>{{ _('AUDELA Finance') }}
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#financeTopNav" aria-controls="financeTopNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="financeTopNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('finance.dashboard') }}">{{ _('Visão geral') }}</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('finance.accounts_list') }}">{{ _('Contas') }}</a></li>
          <li class="nav-item">
            <a class="nav-link dropdown-toggle" href="#" id="masterDataDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-database me-1"></i>{{ _('Dados Mestres') }}
            </a>
            <ul class="dropdown-menu" aria-labelledby="masterDataDropdown">
              <li><a class="dropdown-item" href="{{ url_for('finance_master.list_products') }}">
                <i class="bi bi-box-seam me-2"></i>{{ _('Produtos Financeiros') }}
              </a></li>
              <li><a class="dropdown-item" href="{{ url_for('finance_master.list_counterparties') }}">
                <i class="bi bi-people me-2"></i>{{ _('Contrapartes') }}
              </a></li>
              <li><a class="dropdown-item" href="{{ url_for('finance_master.bank_config') }}">
                <i class="bi bi-bank me-2"></i>{{ _('Configuração Bancária') }}
              </a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('finance.banks') }}">{{ _('Bancos') }}</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('finance.reconciliation') }}">{{ _('Reconciliação') }}</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('finance.settings_categories') }}">{{ _('Configurações') }}</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('finance.help_page') }}">{{ _('Ajuda') }}</a></li>
        </ul>

        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-outline-primary btn-sm" href="{{ url_for('tenant.dashboard') }}">
            <i class="bi bi-arrow-left-circle me-1"></i>
            <span class="d-none d-md-inline">{{ _('Retour au dashboard tenant') }}</span>
          </a>

          {% if transaction_usage %}
            <span class="badge text-bg-light border">
              {{ _('Transações') }}: {{ transaction_usage.current }}/{{ transaction_usage.max_label }}
            </span>
          {% endif %}

          <button class="btn btn-outline-secondary btn-sm" type="button" onclick="window.__toggleTheme()" title="{{ _('Tema') }}">
            <i class="bi bi-moon-stars"></i>
          </button>

          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">{{ lang_label(current_lang) }}</button>
            <ul class="dropdown-menu dropdown-menu-end">
              {% for code, info in supported_langs.items() %}
                <li><a class="dropdown-item" href="{{ url_for('public.set_language', lang_code=code, next=request.full_path) }}">{{ info.label }}</a></li>
              {% endfor %}
            </ul>
          </div>

          <a class="btn btn-outline-danger btn-sm" href="{{ url_for('auth.logout') }}">
            <i class="bi bi-box-arrow-right"></i>
            <span class="ms-1 d-none d-md-inline">{{ _('Sair') }}</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Flash -->
  <div class="container-fluid pt-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category in ['error', 'danger'] else ('success' if category in ['success'] else 'secondary') }}" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <div class="container-fluid pb-4">
    {% block finance_page %}{% endblock %}
  </div>

  <div id="financeHelpChat" class="position-fixed bottom-0 end-0 p-3" style="z-index:1080;">
    <button
      id="financeHelpChatToggle"
      class="btn btn-primary rounded-circle"
      style="width:48px;height:48px;"
      type="button"
      aria-label="{{ _('Abrir ajuda') }}"
      title="{{ _('Abrir ajuda') }}"
    >
      <i class="bi bi-chat-dots"></i>
    </button>

    <div id="financeHelpChatPanel" class="card mt-2 d-none" style="width: 340px; max-width: calc(100vw - 2rem);">
      <div class="card-header d-flex align-items-center justify-content-between py-2">
        <span class="fw-semibold">{{ _('Assistente de suporte') }}</span>
        <button id="financeHelpChatClose" class="btn btn-sm btn-outline-secondary" type="button" aria-label="{{ _('Fechar') }}">×</button>
      </div>
      <div id="financeHelpChatMessages" class="card-body" style="height: 300px; overflow:auto;"></div>
      <div class="card-footer">
        <div class="input-group input-group-sm">
          <input id="financeHelpChatInput" type="text" class="form-control" placeholder="{{ _('Digite sua dúvida...') }}" />
          <button id="financeHelpChatSend" class="btn btn-primary" type="button">{{ _('Enviar') }}</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center text-secondary py-3 small">
    <a href="{{ url_for('public.legal_notice') }}" target="_blank" rel="noopener">{{ _('footer.notice') }}</a>
    <span class="mx-2">·</span>
    <a href="{{ url_for('public.legal_terms') }}" target="_blank" rel="noopener">{{ _('footer.terms') }}</a>
    <span class="mx-2">·</span>
    <a href="{{ url_for('public.legal_privacy') }}" target="_blank" rel="noopener">{{ _('footer.privacy') }}</a>
    <span class="mx-2">·</span>
    <a href="{{ url_for('public.legal_retention') }}" target="_blank" rel="noopener">{{ _('footer.retention') }}</a>
    <span class="mx-2">·</span>
    <a href="{{ url_for('public.legal_cookies') }}" target="_blank" rel="noopener">{{ _('footer.cookies') }}</a>
  </footer>
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script>
    window.onReady(function(){
      function normText(el){
        const t = (el.getAttribute('data-finance-tip') || el.getAttribute('title') || el.getAttribute('aria-label') || el.textContent || '').trim();
        return t.replace(/\s+/g, ' ').trim();
      }

      const tipSelectors = [
        '.navbar .navbar-brand',
        '.navbar .nav-link',
        '.nav-pills .nav-link',
        '.dropdown-item',
        '.btn'
      ].join(',');

      document.querySelectorAll(tipSelectors).forEach(function(el){
        if (el.hasAttribute('data-bs-toggle') || el.classList.contains('disabled')) return;
        const tip = normText(el);
        if (!tip) return;
        el.setAttribute('data-bs-toggle', 'tooltip');
        el.setAttribute('data-bs-placement', 'bottom');
        el.setAttribute('data-bs-title', tip);
      });

      if (window.bootstrap && window.bootstrap.Tooltip) {
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el){
          window.bootstrap.Tooltip.getOrCreateInstance(el);
        });
      }

      const toggle = document.getElementById('financeHelpChatToggle');
      const panel = document.getElementById('financeHelpChatPanel');
      const closeBtn = document.getElementById('financeHelpChatClose');
      const input = document.getElementById('financeHelpChatInput');
      const sendBtn = document.getElementById('financeHelpChatSend');
      const messages = document.getElementById('financeHelpChatMessages');
      if (!toggle || !panel || !closeBtn || !input || !sendBtn || !messages) return;

      function addMsg(text, who){
        const wrap = document.createElement('div');
        wrap.className = 'mb-2 d-flex ' + (who === 'user' ? 'justify-content-end' : 'justify-content-start');
        const b = document.createElement('div');
        b.className = (who === 'user' ? 'bg-primary text-white' : 'bg-body-tertiary') + ' rounded px-2 py-1 small';
        b.style.maxWidth = '85%';
        b.textContent = text;
        wrap.appendChild(b);
        messages.appendChild(wrap);
        messages.scrollTop = messages.scrollHeight;
      }

      function addSuggestions(items){
        if (!Array.isArray(items) || !items.length) return;
        const row = document.createElement('div');
        row.className = 'd-flex flex-wrap gap-1 mb-2';
        items.slice(0, 4).forEach(function(s){
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-outline-secondary btn-sm';
          btn.textContent = s;
          btn.addEventListener('click', function(){
            input.value = s;
            send();
          });
          row.appendChild(btn);
        });
        messages.appendChild(row);
        messages.scrollTop = messages.scrollHeight;
      }

      async function send(){
        const msg = (input.value || '').trim();
        if (!msg) return;
        addMsg(msg, 'user');
        input.value = '';
        sendBtn.disabled = true;
        try {
          const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
          const res = await fetch('{{ url_for("finance.help_chat") }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(csrf ? {'X-CSRFToken': csrf} : {})
            },
            body: JSON.stringify({ message: msg })
          });
          const data = await res.json();
          if (!res.ok || !data.ok) {
            addMsg(data.error || window.t('Erro ao carregar.'), 'bot');
          } else {
            addMsg(data.reply || window.t('Sem resposta.'), 'bot');
            addSuggestions(data.suggestions || []);
          }
        } catch (e) {
          addMsg(window.t('Erro ao carregar.'), 'bot');
        } finally {
          sendBtn.disabled = false;
          input.focus();
        }
      }

      let seeded = false;
      function openPanel(){
        panel.classList.remove('d-none');
        if (!seeded) {
          addMsg(window.t('Olá! Posso ajudar com Cashflow, Liquidez, GAP, NII, Reconciliação e Plano de contas.'), 'bot');
          addSuggestions([
            window.t('Como funciona o cashflow?'),
            window.t('Como interpretar a liquidez?'),
            window.t('Como fazer reconciliação bancária?'),
            window.t('Onde configuro o plano de contas?')
          ]);
          seeded = true;
        }
        input.focus();
      }

      toggle.addEventListener('click', function(){
        if (panel.classList.contains('d-none')) openPanel();
        else panel.classList.add('d-none');
      });
      closeBtn.addEventListener('click', function(){ panel.classList.add('d-none'); });
      sendBtn.addEventListener('click', send);
      input.addEventListener('keydown', function(e){
        if (e.key === 'Enter') {
          e.preventDefault();
          send();
        }
      });
    });
  </script>
{% endblock %}
