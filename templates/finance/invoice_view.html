{% extends "finance/base_finance.html" %}

{% block finance_content %}
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h4 class="mb-0">{{ _('Fatura') }} {{ invoice.invoice_number }}</h4>
      <div class="text-secondary small">
        {{ invoice.issue_date }}{% if invoice.due_date %} • {{ _('Vence') }} {{ invoice.due_date }}{% endif %}
      </div>
    </div>
    <div class="btn-group">
      <a class="btn btn-outline-secondary" href="{{ url_for('finance.invoice_edit', invoice_id=invoice.id) }}">{{ _('Editar') }}</a>
      <a class="btn btn-outline-primary" href="{{ url_for('finance.invoice_export', invoice_id=invoice.id, country='fr') }}">{{ _('Export FR (ZIP)') }}</a>
      <a class="btn btn-outline-primary" href="{{ url_for('finance.invoice_export', invoice_id=invoice.id, country='it') }}">{{ _('Export IT (ZIP)') }}</a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="text-secondary small">{{ _('Tipo') }}</div>
              <div class="fw-semibold">{{ invoice.invoice_type }}</div>
            </div>
            <div class="col-md-4">
              <div class="text-secondary small">{{ _('Status') }}</div>
              <div class="fw-semibold">{{ invoice.status }}</div>
            </div>
            <div class="col-md-4">
              <div class="text-secondary small">{{ _('Moeda') }}</div>
              <div class="fw-semibold">{{ invoice.currency }}</div>
            </div>
            <div class="col-md-12">
              <div class="text-secondary small">{{ _('Contraparte') }}</div>
              <div class="fw-semibold">{{ invoice.counterparty.name if invoice.counterparty else '' }}</div>
            </div>
          </div>

          <hr class="my-3">

          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>{{ _('Descrição') }}</th>
                  <th class="text-end">{{ _('Qtd') }}</th>
                  <th class="text-end">{{ _('Preço') }}</th>
                  <th class="text-end">{{ _('IVA %') }}</th>
                  <th class="text-end">{{ _('Total') }}</th>
                </tr>
              </thead>
              <tbody>
                {% for ln in invoice.lines %}
                  <tr>
                    <td>{{ ln.description }}</td>
                    <td class="text-end">{{ '%.2f'|format(ln.quantity) }}</td>
                    <td class="text-end">{{ '%.2f'|format(ln.unit_price) }}</td>
                    <td class="text-end">{{ '%.2f'|format(ln.vat_rate) }}</td>
                    <td class="text-end">{{ '%.2f'|format(ln.gross_amount) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <th colspan="4" class="text-end">{{ _('Total') }}</th>
                  <th class="text-end">{{ '%.2f'|format(invoice.total_gross or 0) }} {{ invoice.currency }}</th>
                </tr>
              </tfoot>
            </table>
          </div>

          {% if invoice.notes %}
            <div class="mt-3">
              <div class="text-secondary small">{{ _('Notas') }}</div>
              <div>{{ invoice.notes }}</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="card-title">{{ _('Ações') }}</h6>

          {% if invoice.status != 'paid' %}
            <form method="post" action="{{ url_for('finance.invoice_mark_paid', invoice_id=invoice.id) }}" class="mb-3">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="mb-2">
                <label class="form-label">{{ _('Conta') }}</label>
                <select class="form-select" name="account_id" required>
                  <option value="">—</option>
                  {% for acc in accounts %}
                    <option value="{{ acc.id }}" {% if invoice.settlement_account_id==acc.id %}selected{% endif %}>{{ acc.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">{{ _('Data pagamento') }}</label>
                <input class="form-control" type="date" name="payment_date" value="{{ today }}">
              </div>
              <button class="btn btn-success w-100" type="submit">{{ _('Marcar como paga') }}</button>
            </form>
          {% else %}
            <div class="alert alert-success">{{ _('Já está paga.') }}</div>
          {% endif %}

          <form method="post" action="{{ url_for('finance.invoice_delete', invoice_id=invoice.id) }}" onsubmit="return confirm('Delete invoice?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-outline-danger w-100" type="submit">{{ _('Remover') }}</button>
          </form>
        </div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h6 class="card-title">{{ _('Dica') }}</h6>
          <div class="text-secondary small">
            {{ _('FR ZIP gera PDF + XML Factur-X (CII/EN16931). IT ZIP gera PDF + XML FatturaPA (FPR12).') }}
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
