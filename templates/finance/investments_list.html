{% extends "finance/base_finance.html" %}
{% set active = 'investments' %}

{% block finance_content %}
  <div class="d-flex align-items-center justify-content-between gap-2 mb-3">
    <div>
      <div class="h5 mb-0">{{ _('Investimentos') }}</div>
      <div class="text-secondary small">{{ _('Opções EDF e Stock Exchange, com impacto em cashflow/liquidez.') }}</div>
    </div>
    <a class="btn btn-primary btn-sm" href="{{ url_for('finance.investment_new') }}">
      <i class="bi bi-plus-lg me-1"></i>{{ _('Novo investimento') }}
    </a>
  </div>

  <div class="card">
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end mb-3">
        <div class="col-12 col-md-4">
          <label class="form-label">{{ _('Pesquisar') }}</label>
          <input class="form-control" name="q" value="{{ filters.q }}" placeholder="{{ _('Nome ou código') }}" />
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">{{ _('Tipo') }}</label>
          <select class="form-select" name="provider">
            <option value="">{{ _('Todos') }}</option>
            <option value="edf" {% if filters.provider=='edf' %}selected{% endif %}>EDF</option>
            <option value="stock_exchange" {% if filters.provider=='stock_exchange' %}selected{% endif %}>{{ _('Stock Exchange') }}</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">{{ _('Status') }}</label>
          <select class="form-select" name="status">
            <option value="">{{ _('Todos') }}</option>
            <option value="active" {% if filters.status=='active' %}selected{% endif %}>{{ _('Active') }}</option>
            <option value="closed" {% if filters.status=='closed' %}selected{% endif %}>{{ _('Closed') }}</option>
          </select>
        </div>
        <div class="col-12 col-md-2">
          <button class="btn btn-outline-secondary w-100">{{ _('Filtrar') }}</button>
        </div>
      </form>

      {% if items %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>{{ _('Nome') }}</th>
                <th>{{ _('Tipo') }}</th>
                <th>{{ _('Código') }}</th>
                <th class="text-end">{{ _('Investido') }}</th>
                <th class="text-end">{{ _('Valor atual') }}</th>
                <th class="text-end">{{ _('P/L') }}</th>
                <th>{{ _('Status') }}</th>
                <th class="text-end">{{ _('Ações') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for i in items %}
                <tr>
                  <td class="fw-semibold">{{ i.name }}</td>
                  <td>{{ i.provider_label }}</td>
                  <td>{{ i.instrument_code or '' }}</td>
                  <td class="text-end">{{ i.invested_fmt }}</td>
                  <td class="text-end">{{ i.current_fmt }}</td>
                  <td class="text-end">{{ i.pnl_fmt }}</td>
                  <td><span class="badge text-bg-light border">{{ i.status_label }}</span></td>
                  <td class="text-end">
                    <div class="finance-row-actions justify-content-end">
                    <form method="post" action="{{ url_for('finance.investment_update', investment_id=i.id) }}" class="d-inline-flex align-items-center gap-1 finance-inline-form">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                      <input class="form-control form-control-sm inv-w-110" name="current_value" placeholder="{{ _('Valor') }}" />
                      <select class="form-select form-select-sm inv-w-95" name="status">
                        <option value="active" {% if i.status=='active' %}selected{% endif %}>{{ _('Active') }}</option>
                        <option value="closed" {% if i.status=='closed' %}selected{% endif %}>{{ _('Closed') }}</option>
                      </select>
                      <button class="btn btn-outline-secondary btn-sm">{{ _('Atualizar') }}</button>
                    </form>

                    <form method="post" action="{{ url_for('finance.investment_cash_event', investment_id=i.id) }}" class="d-inline-flex align-items-center gap-1 ms-1 finance-inline-form">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                      <select class="form-select form-select-sm inv-w-95" name="event_type">
                        <option value="buy">{{ _('Compra') }}</option>
                        <option value="sell" selected>{{ _('Venda') }}</option>
                        <option value="dividend">{{ _('Dividendo') }}</option>
                        <option value="fee">{{ _('Taxa') }}</option>
                      </select>
                      <input class="form-control form-control-sm inv-w-100" name="amount" placeholder="{{ _('Valor') }}" required />
                      <input class="form-control form-control-sm inv-w-145" type="date" name="txn_date" />
                      <button class="btn btn-outline-primary btn-sm">{{ _('Registrar') }}</button>
                    </form>

                    <button type="button"
                            class="btn btn-outline-info btn-sm ms-1 js-invest-history finance-action-btn"
                            data-history-url="{{ url_for('finance.investment_history', investment_id=i.id) }}"
                            data-name="{{ i.name }}"
                            data-symbol="{{ i.instrument_code or '' }}">
                      {{ _('Historique') }}
                    </button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-secondary">{{ _('Nenhum investimento registrado ainda.') }}</div>
      {% endif %}
    </div>
  </div>

  <div class="modal fade" id="investment-history-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="investment-history-title">{{ _('Historique') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex gap-2 mb-2">
            <button type="button" class="btn btn-sm btn-outline-secondary js-history-range" data-range="24h">24h</button>
            <button type="button" class="btn btn-sm btn-outline-secondary js-history-range" data-range="1y">1 an</button>
            <button type="button" class="btn btn-sm btn-outline-secondary js-history-range" data-range="5y">5 ans</button>
          </div>
          <div id="investment-history-status" class="small text-secondary mb-2"></div>
          <div id="investment-history-return" class="mb-2"></div>
          <div id="investment-history-chart" style="height: 320px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (window.onReady || function(fn){ window.addEventListener('load', fn); })(function(){
      const modalEl = document.getElementById('investment-history-modal');
      const titleEl = document.getElementById('investment-history-title');
      const statusEl = document.getElementById('investment-history-status');
      const returnEl = document.getElementById('investment-history-return');
      const chartEl = document.getElementById('investment-history-chart');
      if (!modalEl || !titleEl || !statusEl || !returnEl || !chartEl) return;

      let currentUrl = '';
      let currentName = '';
      let currentSymbol = '';
      let currentRange = '1y';
      let chart = null;
      let pendingChartPayload = null;

      function setActiveRange(){
        document.querySelectorAll('.js-history-range').forEach((btn) => {
          const on = btn.getAttribute('data-range') === currentRange;
          btn.classList.toggle('btn-primary', on);
          btn.classList.toggle('btn-outline-secondary', !on);
        });
      }

      function ensureChart(){
        if (!window.echarts) return null;
        if (!chart) chart = echarts.init(chartEl);
        return chart;
      }

      function renderHistoryChart(labels, values){
        const ch = ensureChart();
        if (!ch) {
          statusEl.textContent = 'Bibliothèque graphique indisponible.';
          return;
        }
        ch.setOption({
          tooltip: { trigger: 'axis' },
          xAxis: { type: 'category', data: labels, axisLabel: { show: false } },
          yAxis: { type: 'value', scale: true },
          series: [{
            name: currentSymbol || 'Price',
            type: 'line',
            data: values,
            smooth: true,
            showSymbol: false,
            areaStyle: { opacity: 0.12 },
          }],
        });
        setTimeout(() => { try { ch.resize(); } catch (_e) {} }, 120);
      }

      function renderCumulativeReturn(values){
        if (!values || values.length < 2) {
          returnEl.innerHTML = `<span class="badge text-bg-light border">Performance cumulée: n/a</span>`;
          return;
        }
        const first = Number(values[0] || 0);
        const last = Number(values[values.length - 1] || 0);
        if (!Number.isFinite(first) || first === 0 || !Number.isFinite(last)) {
          returnEl.innerHTML = `<span class="badge text-bg-light border">Performance cumulée: n/a</span>`;
          return;
        }
        const pct = ((last - first) / first) * 100;
        const cls = pct >= 0 ? 'text-bg-success' : 'text-bg-danger';
        const sign = pct >= 0 ? '+' : '';
        returnEl.innerHTML = `<span class="badge ${cls}">Performance cumulée: ${sign}${pct.toFixed(2)}%</span>`;
      }

      async function loadHistory(){
        if (!currentUrl) return;
        setActiveRange();
        statusEl.textContent = 'Chargement...';

        const url = new URL(currentUrl, window.location.origin);
        url.searchParams.set('horizon', currentRange);

        try {
          const res = await fetch(url);
          const payload = await res.json();
          if (!res.ok) throw new Error(payload.error || 'history load failed');

          const points = payload.points || [];
          if (!points.length) {
            statusEl.textContent = 'Aucune donnée historique disponible.';
            returnEl.innerHTML = `<span class="badge text-bg-light border">Performance cumulée: n/a</span>`;
            const ch = ensureChart();
            if (ch) ch.clear();
            return;
          }

          statusEl.textContent = `${currentSymbol || payload.symbol || ''} · ${currentRange} · ${points.length} points`;
          const labels = points.map((p) => p.t);
          const values = points.map((p) => Number(p.v || 0));
          renderCumulativeReturn(values);
          if (modalEl.classList.contains('show') && chartEl.clientWidth > 0) {
            renderHistoryChart(labels, values);
            pendingChartPayload = null;
          } else {
            pendingChartPayload = { labels, values };
          }
        } catch (_err) {
          statusEl.textContent = 'Erreur lors du chargement de l\'historique.';
          returnEl.innerHTML = `<span class="badge text-bg-light border">Performance cumulée: n/a</span>`;
          const ch = ensureChart();
          if (ch) ch.clear();
        }
      }

      document.querySelectorAll('.js-invest-history').forEach((btn) => {
        btn.addEventListener('click', () => {
          currentUrl = btn.getAttribute('data-history-url') || '';
          currentName = btn.getAttribute('data-name') || '';
          currentSymbol = btn.getAttribute('data-symbol') || '';
          currentRange = '1y';
          titleEl.textContent = `Historique · ${currentName}${currentSymbol ? ' (' + currentSymbol + ')' : ''}`;
          returnEl.innerHTML = `<span class="badge text-bg-light border">Performance cumulée: ...</span>`;

          if (window.bootstrap?.Modal) {
            window.bootstrap.Modal.getOrCreateInstance(modalEl).show();
          }
          loadHistory();
        });
      });

      document.querySelectorAll('.js-history-range').forEach((btn) => {
        btn.addEventListener('click', () => {
          currentRange = btn.getAttribute('data-range') || '1y';
          loadHistory();
        });
      });

      modalEl.addEventListener('shown.bs.modal', () => {
        if (pendingChartPayload) {
          renderHistoryChart(pendingChartPayload.labels, pendingChartPayload.values);
          pendingChartPayload = null;
          return;
        }
        if (chart) {
          try { chart.resize(); } catch (_e) {}
        }
      });

      window.addEventListener('resize', () => {
        if (chart) {
          try { chart.resize(); } catch (_e) {}
        }
      });
    });
  </script>
{% endblock %}

{% block head_extra %}
  {{ super() }}
  <style>
    .finance-row-actions {
      display: inline-flex;
      flex-wrap: wrap;
      gap: .35rem;
    }

    .inv-w-95 { width: 95px; }
    .inv-w-100 { width: 100px; }
    .inv-w-110 { width: 110px; }
    .inv-w-145 { width: 145px; }

    @media (max-width: 767.98px) {
      .finance-row-actions {
        display: flex;
        justify-content: stretch !important;
      }

      .finance-row-actions .finance-inline-form,
      .finance-row-actions .finance-action-btn {
        width: 100%;
        margin-left: 0 !important;
      }

      .finance-row-actions .finance-inline-form {
        flex-wrap: wrap;
      }

      .finance-row-actions .finance-inline-form .form-control,
      .finance-row-actions .finance-inline-form .form-select,
      .finance-row-actions .finance-inline-form .btn,
      .finance-row-actions .finance-action-btn {
        width: 100%;
      }
    }
  </style>
{% endblock %}
