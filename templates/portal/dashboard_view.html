{% extends "portal/layout.html" %}
{% set title = dashboard.name %}

{% block head_extra %}
  {{ super() }}
  <style>
    .bi-floating-filters {
      position: fixed;
      top: 110px;
      right: 18px;
      width: min(420px, calc(100vw - 24px));
      max-height: calc(100vh - 130px);
      z-index: 1040;
      box-shadow: var(--bs-box-shadow-sm);
      border: 1px solid var(--bs-border-color);
      border-radius: .75rem;
      background: var(--bs-body-bg);
      display: flex;
      flex-direction: column;
    }
    .bi-floating-filters .bi-floating-head {
      cursor: move;
      user-select: none;
      border-bottom: 1px solid var(--bs-border-color);
      padding: .55rem .7rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
    }
    .bi-floating-filters .bi-floating-body {
      overflow: auto;
      padding: .7rem;
    }
    .bi-floating-filters.is-collapsed .bi-floating-body { display: none; }
    @media (max-width: 991.98px) {
      .bi-floating-filters {
        right: 8px;
        left: 8px;
        width: auto;
        top: auto;
        bottom: 8px;
        max-height: 60vh;
      }
      .bi-floating-filters .bi-floating-head { cursor: default; }
    }
  </style>
{% endblock %}

{% block portal_content %}
<div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">{{ dashboard.name }}</h1>
    {% if dashboard.description %}<div class="text-secondary">{{ dashboard.description }}</div>{% endif %}
  </div>

  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('portal.dashboards_list') }}">
      <i class="bi bi-arrow-left"></i> {{ _('Voltar') }}
    </a>

    <button class="btn btn-outline-secondary btn-sm" id="bi-floating-filters-toggle" type="button">
      <i class="bi bi-funnel me-1"></i>{{ _('Filtres flottants') }}
    </button>

    <button class="btn btn-outline-primary btn-sm" id="layout-edit">
      <i class="bi bi-arrows-move"></i> {{ _('Editar layout') }}
    </button>
    <button class="btn btn-primary btn-sm d-none" id="layout-save">
      <i class="bi bi-check2"></i> {{ _('Salvar layout') }}
    </button>
    <button class="btn btn-success btn-sm d-none" id="layout-add-card" data-bs-toggle="offcanvas" data-bs-target="#addCardCanvas">
  <i class="bi bi-plus-lg"></i> {{ _('Adicionar card') }}
</button>
    <button class="btn btn-outline-secondary btn-sm d-none" id="layout-cancel">
      <i class="bi bi-x"></i> {{ _('Cancelar edição') }}
    </button>
  </div>
</div>

<div id="bi-floating-filters" class="bi-floating-filters" aria-label="{{ _('Filtres flottants') }}">
  <div id="bi-floating-filters-head" class="bi-floating-head">
    <div class="fw-semibold d-flex align-items-center gap-2">
      <i class="bi bi-funnel"></i>
      <span>{{ _('Filtres') }}</span>
    </div>
    <div class="d-flex align-items-center gap-1">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="bi-floating-filters-dock" title="{{ _('Reencaixar') }}"><i class="bi bi-bounding-box"></i></button>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="bi-floating-filters-collapse" title="{{ _('Minimizar') }}"><i class="bi bi-chevron-down"></i></button>
    </div>
  </div>
  <div class="bi-floating-body">
    <div class="row g-2 align-items-end">
      <div class="col-12">
        <label class="form-label mb-1">{{ _('Champ') }}</label>
        <select id="bi-filter-field" class="form-select form-select-sm"></select>
      </div>
      <div class="col-6">
        <label class="form-label mb-1">{{ _('Opérateur') }}</label>
        <select id="bi-filter-op" class="form-select form-select-sm">
          <option value="eq">=</option>
          <option value="contains">contains</option>
          <option value="gt">&gt;</option>
          <option value="lt">&lt;</option>
        </select>
      </div>
      <div class="col-6">
        <label class="form-label mb-1">{{ _('Valeur') }}</label>
        <input id="bi-filter-value" class="form-control form-control-sm" type="text" placeholder="value" />
      </div>
      <div class="col-12 d-flex flex-wrap gap-2">
        <button class="btn btn-outline-primary btn-sm" id="bi-add-filter">{{ _('Adicionar filtro') }}</button>
        <button class="btn btn-outline-secondary btn-sm" id="bi-clear-filters">{{ _('Limpar filtros') }}</button>
        <button class="btn btn-outline-secondary btn-sm" id="bi-export-pdf"><i class="bi bi-filetype-pdf"></i> {{ _('Exportar PDF') }}</button>
      </div>
    </div>
    <div id="bi-filter-summary" class="mt-2"></div>
  </div>
</div>

{% if not cards %}
  <div class="alert alert-info">{{ _('Nenhum card ainda. Crie um dashboard escolhendo perguntas.') }}</div>
{% endif %}

<div class="grid-stack" id="dash-grid" data-dashboard-id="{{ dashboard.id }}"></div>
<!-- Add Card (Builder) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="addCardCanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">{{ _('Adicionar card') }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div class="mb-2">
      <label class="form-label">{{ _('Buscar pergunta') }}</label>
      <input class="form-control" id="addcard-search" placeholder="{{ _('Digite para filtrar...') }}" />
    </div>
    <div class="mb-2">
      <label class="form-label">{{ _('Pergunta') }}</label>
      <select class="form-select" id="addcard-question">
        <option value="">--</option>
        {% for q in all_questions %}
          <option value="{{ q.id }}">{{ q.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-2">
      <label class="form-label">{{ _('Visualização') }}</label>
      <select class="form-select" id="addcard-type">
        <option value="table">{{ _('Tabela') }}</option>
        <option value="bar">Bar</option>
        <option value="line">Line</option>
        <option value="area">Area</option>
        <option value="pie">Pie</option>
        <option value="scatter">Scatter</option>
        <option value="gauge">Gauge</option>
        <option value="pivot">Pivot</option>
      </select>
      <div class="form-text">{{ _('Você pode refinar depois em Configurar visualização.') }}</div>
    </div>
    <div class="mb-2">
      <label class="form-label">{{ _('Parâmetros (JSON)') }}</label>
      <textarea class="form-control" id="addcard-params" rows="4" placeholder="{\n  \"from\": \"2025-01-01\"\n}"></textarea>
    </div>
    <div class="d-flex gap-2 mt-3">
      <button class="btn btn-primary" id="addcard-create"><i class="bi bi-plus-lg"></i> {{ _('Adicionar') }}</button>
      <button class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">{{ _('Cancelar') }}</button>
    </div>
    <div class="small-muted mt-2" id="addcard-status"></div>
  </div>
</div>

<!-- Initial cards as HTML templates (hydrated by JS into Gridstack) -->
<template id="dash-cards-template">
  {% for item in cards %}
    {% set pos = item.card.position_json or {} %}
    <div class="grid-stack-item" gs-x="{{ pos.get('x', 0) }}" gs-y="{{ pos.get('y', loop.index0 * 6) }}" gs-w="{{ pos.get('w', 12) }}" gs-h="{{ pos.get('h', 6) }}" data-bi-card="1" data-card-id="{{ item.card.id }}">
      <div class="grid-stack-item-content">
        <div class="card-head">
          <div class="d-flex align-items-center gap-2" style="min-width: 0;">
            <i class="bi bi-ui-checks" style="opacity:.65"></i>
            <div class="card-title">{{ item.question.name }}</div>
          </div>
          <div class="d-flex gap-1">
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('portal.questions_viz', question_id=item.question.id) }}" title="{{ _('Configurar visualização') }}">
              <i class="bi bi-sliders"></i>
            </a>
            <button class="btn btn-outline-danger btn-sm d-none" data-card-remove="1" title="{{ _('Remover card') }}">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
        <div class="card-body-inner">
          {% if item.result.error %}
            <div class="alert alert-danger py-2">{{ _('Erro') }}: {{ item.result.error }}</div>
          {% endif %}
          <div class="bi-viz viz" id="viz-{{ item.card.id }}"></div>
          <script type="application/json" id="data-{{ item.card.id }}">{{ item.result|tojson }}</script>
          <script type="application/json" id="cfg-{{ item.card.id }}">{{ item.viz_config|tojson }}</script>
        </div>
      </div>
    </div>
  {% endfor %}
</template>
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='bi/bi_viz.js') }}"></script>
  <script src="{{ url_for('static', filename='bi/bi_dashboard.js') }}"></script>
{% endblock %}
