{% extends "portal/layout.html" %}
{% set title = _('Explorar') %}

{% block head_extra %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
{% endblock %}

{% block portal_content %}
<div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">{{ _('Explorar') }}</h1>
    <div class="text-secondary">{{ _('Explore dados e crie visualizações como no Superset/Metabase.') }}</div>
  </div>
</div>

<style>
  /* Ensure the preview area has height so ECharts can render */
  #ex-viz.viz { min-height: 320px; width: 100%; }
</style>
<div class="row g-3">
  <div class="col-12 col-lg-4">
    <div class="card border-0 shadow-sm" style="border-radius: 1rem;">
      <div class="card-body">
        <label class="form-label">{{ _('Selecione uma pergunta') }}</label>
        <select class="form-select" id="ex-question">
          <option value="">--</option>
          {% for q in questions %}
            <option value="{{ q.id }}">{{ q.name }}</option>
          {% endfor %}
        </select>

        <div class="mt-3">
          <label class="form-label">{{ _('Parâmetros') }}</label>
          <div class="form-text">{{ _('Parametros parametrizados devem ser passados via filtros ou definidos na Pergunta. tenant_id é aplicado automaticamente.') }}</div>
        </div>

        <div class="row g-2 mt-3">
          <div class="col-12">
            <label class="form-label">{{ _('Visualização') }}</label>

            <div class="viz-type-picker d-flex flex-wrap gap-2" role="tablist" aria-label="{{ _('Visualização') }}">
              <button type="button" class="btn btn-outline-secondary vt-btn" data-type="table" aria-pressed="false" title="{{ _('Tabela') }}"><i class="bi bi-table"></i> <span class="vis-type-label">{{ _('Tabela') }}</span></button>
              <button type="button" class="btn btn-outline-secondary vt-btn" data-type="bar" aria-pressed="false" title="{{ _('Bar') }}"><i class="bi bi-bar-chart"></i> <span class="vis-type-label">{{ _('Bar') }}</span></button>
              <button type="button" class="btn btn-outline-secondary vt-btn" data-type="line" aria-pressed="false" title="{{ _('Line') }}"><i class="bi bi-graph-up"></i> <span class="vis-type-label">{{ _('Line') }}</span></button>
              <button type="button" class="btn btn-outline-secondary vt-btn" data-type="area" aria-pressed="false" title="{{ _('Area') }}"><i class="bi bi-bar-chart-stacked"></i> <span class="vis-type-label">{{ _('Area') }}</span></button>
              <button type="button" class="btn btn-outline-secondary vt-btn" data-type="pie" aria-pressed="false" title="{{ _('Pie') }}"><i class="bi bi-pie-chart"></i> <span class="vis-type-label">{{ _('Pie') }}</span></button>
              <button type="button" class="btn btn-outline-secondary vt-btn" data-type="scatter" aria-pressed="false" title="{{ _('Scatter') }}"><i class="bi bi-dots"></i> <span class="vis-type-label">{{ _('Scatter') }}</span></button>
              <button type="button" class="btn btn-outline-secondary vt-btn" data-type="gauge" aria-pressed="false" title="{{ _('Gauge') }}"><i class="bi bi-speedometer2"></i> <span class="vis-type-label">{{ _('Gauge') }}</span></button>
              <button type="button" class="btn btn-outline-secondary vt-btn" data-type="pivot" aria-pressed="false" title="{{ _('Pivot') }}"><i class="bi bi-layout-text-window-reverse"></i> <span class="vis-type-label">{{ _('Pivot') }}</span></button>
            </div>

            <select class="form-select visually-hidden" id="ex-type">
              <option value="table">{{ _('Tabela') }}</option>
              <option value="bar">{{ _('Bar') }}</option>
              <option value="line">{{ _('Line') }}</option>
              <option value="area">{{ _('Area') }}</option>
              <option value="pie">{{ _('Pie') }}</option>
              <option value="scatter">{{ _('Scatter') }}</option>
              <option value="gauge">{{ _('Gauge') }}</option>
              <option value="pivot">{{ _('Pivot') }}</option>
            </select>
            <style>
              .viz-type-picker .vt-btn { min-width: 110px; display:flex; align-items:center; gap:.5rem; }
              .viz-type-picker .vt-btn i { font-size: 1.1rem; }
              .viz-type-picker .vt-btn.active { border-width:2px; }
              .vis-type-label { display:inline-block; }
            </style>
          </div>
          <div class="col-6">
            <label class="form-label">{{ _('Dimensão') }}</label>
            <select class="form-select" id="ex-dim"></select>
          </div>
          <div class="col-6">
            <label class="form-label">{{ _('Métrica') }}</label>
            <select class="form-select" id="ex-met"></select>
            <div class="mt-2">
              <label class="form-label">{{ _('Agregação') }}</label>
              <select id="ex-agg-func" class="form-select form-select-sm">
                <option value="SUM">SUM</option>
                <option value="AVG">AVG</option>
                <option value="COUNT">COUNT</option>
                <option value="MIN">MIN</option>
                <option value="MAX">MAX</option>
              </select>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">{{ _('Drill-down') }}</label>
            <select class="form-select" id="ex-drill"></select>
            <div class="form-text">{{ _('Clique no gráfico para filtrar por um valor.') }}</div>
          </div>

          <div class="col-12" id="ex-pivot-box" style="display:none;">
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">{{ _('Pivot linhas') }}</label>
                <select class="form-select" id="ex-pr"></select>
              </div>
              <div class="col-6">
                <label class="form-label">{{ _('Pivot colunas') }}</label>
                <select class="form-select" id="ex-pc"></select>
              </div>
              <div class="col-12">
                <label class="form-label">{{ _('Pivot valor') }}</label>
                <select class="form-select" id="ex-pv"></select>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mt-3">
          <button class="btn btn-primary" id="ex-refresh"><i class="bi bi-arrow-repeat"></i> {{ _('Atualizar') }}</button>
          <button class="btn btn-outline-secondary" id="ex-save"><i class="bi bi-save"></i> {{ _('Salvar visualização') }}</button>
        </div>

        <hr class="my-3" />

        <label class="form-label">{{ _('Adicionar ao dashboard') }}</label>
        <div class="input-group">
          <select class="form-select" id="ex-dashboard">
            <option value="">--</option>
            {% for d in dashboards %}
              <option value="{{ d.id }}">{{ d.name }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-outline-primary" id="ex-add-dash">{{ _('Adicionar') }}</button>
        </div>
        <div class="form-text">{{ _('Cria um card no dashboard com esta visualização.') }}</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-8">
    <div class="card border-0 shadow-sm" style="border-radius: 1rem;">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div class="fw-semibold">{{ _('Prévia') }}</div>
          <div class="small-muted" id="ex-status"></div>
        </div>
        <div class="mt-2">
          <div id="ex-viz" class="viz"></div>
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-sm mt-3" style="border-radius: 1rem;">
      <div class="card-body">
        <div class="fw-semibold mb-2">{{ _('Filtros') }}</div>
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-4">
            <label class="form-label mb-1">{{ _('Campo') }}</label>
            <select id="ex-filter-field" class="form-select form-select-sm"></select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1">&nbsp;</label>
            <select id="ex-filter-op" class="form-select form-select-sm">
              <option value="eq">=</option>
              <option value="contains">contains</option>
              <option value="gt">&gt;</option>
              <option value="lt">&lt;</option>
            </select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label mb-1">&nbsp;</label>
            <input id="ex-filter-value" class="form-control form-control-sm" type="text" placeholder="value" />
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">&nbsp;</label>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm" id="ex-add-filter">{{ _('Adicionar filtro') }}</button>
              <button class="btn btn-outline-secondary btn-sm" id="ex-clear-filters">{{ _('Limpar filtros') }}</button>
            </div>
          </div>
        </div>
        <div id="ex-filter-summary" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='bi/bi_viz.js') }}"></script>
  <script src="{{ url_for('static', filename='bi/bi_explore.js') }}"></script>
{% endblock %}
