{% extends "portal/layout.html" %}
{% set title = _('Report Builder') %}

{% block head_extra %}
  {{ super() }}
  <style>
    .rb-panel { border:1px solid var(--bs-border-color); border-radius: .75rem; background: var(--bs-body-bg); }
    .rb-palette .rb-item { cursor: grab; user-select:none; }
    .rb-canvas { min-height: 620px; background: #f8f9fa; border:1px dashed var(--bs-border-color); border-radius: .75rem; }
    .rb-section { background: #fff; border:1px solid var(--bs-border-color); border-radius: .75rem; padding: .75rem; }
    .rb-section-title { font-size: .85rem; text-transform: uppercase; letter-spacing: .04em; color: var(--bs-secondary-color); }
    .rb-block { border:1px solid var(--bs-border-color); border-radius: .75rem; background: #fff; padding: .6rem .75rem; display:flex; align-items:center; justify-content-between; gap:.6rem; }
    .rb-block .meta { display:flex; align-items:center; gap:.5rem; }
    .rb-block .badge { font-weight:600; }
    .rb-drop-hint { color: var(--bs-secondary-color); font-size:.9rem; }
    .rb-color-palette .rb-swatch { cursor: pointer; }
    .rb-color-palette .rb-swatch { padding:0; }
    .rb-color-palette .rb-swatch:not(.btn) { border:none; }
    .rb-data-card { border:1px solid var(--bs-border-color); border-radius: .65rem; background: var(--bs-body-bg); }
    .rb-data-head { display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.45rem .6rem; border-bottom:1px solid var(--bs-border-color); }
    .rb-data-fields { display:grid; gap:.35rem; padding:.6rem; max-height: 230px; overflow:auto; }
    .rb-data-field { cursor: grab; user-select:none; border:1px solid var(--bs-border-color); border-radius:.55rem; padding:.35rem .5rem; background: #fff; display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
    .rb-data-field small { color: var(--bs-secondary-color); }
    .rb-data-search { border-radius: .6rem; }
    .rb-rich-toolbar .btn { min-width: 34px; }
    #rb-detail.rb-dropzone {
      display: grid !important;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: .5rem;
    }
    #rb-detail .rb-drop-hint { grid-column: 1 / -1; }
    #rb-detail .rb-block-instance[data-type="data_field"] { grid-column: auto; }
    #rb-detail .rb-block-instance:not([data-type="data_field"]) { grid-column: 1 / -1; }
    @media (max-width: 991.98px) {
      #rb-detail.rb-dropzone { grid-template-columns: 1fr; }
      #rb-detail .rb-block-instance[data-type="data_field"] { grid-column: 1 / -1; }
    }
    .rb-floating-explorer {
      position: fixed;
      top: 110px;
      right: 18px;
      width: min(380px, calc(100vw - 24px));
      max-height: calc(100vh - 130px);
      z-index: 1040;
      box-shadow: var(--bs-box-shadow-sm);
      display: flex;
      flex-direction: column;
    }
    .rb-floating-explorer .rb-floating-head {
      cursor: move;
      user-select: none;
      border-bottom: 1px solid var(--bs-border-color);
      padding: .55rem .7rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
    }
    .rb-floating-explorer .rb-floating-body {
      overflow: auto;
      padding: .65rem;
    }
    .rb-floating-explorer.is-collapsed .rb-floating-body { display: none; }
    @media (max-width: 991.98px) {
      .rb-floating-explorer {
        right: 8px;
        left: 8px;
        width: auto;
        top: auto;
        bottom: 8px;
        max-height: 55vh;
      }
      .rb-floating-explorer .rb-floating-head { cursor: default; }
    }
  </style>
{% endblock %}

{% block portal_content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h4 class="mb-0">{{ report.name }}</h4>
    <div class="text-muted small">{{ _('Fonte') }}: {{ source.name }} ({{ source.type }})</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('portal.reports_list') }}"><i class="bi bi-arrow-left me-1"></i>{{ _('Voltar') }}</a>
    <button class="btn btn-outline-secondary" type="button" id="rb-floating-explorer-toggle"><i class="bi bi-layout-sidebar-inset-reverse me-1"></i>{{ _('Data Explorer') }}</button>
    <a class="btn btn-outline-secondary" target="_blank" href="{{ url_for('portal.report_view', report_id=report.id) }}">
      <i class="bi bi-eye me-1"></i>{{ _('Visualizar') }}
    </a>
    <a class="btn btn-outline-secondary" href="{{ url_for('portal.report_pdf', report_id=report.id) }}">
      <i class="bi bi-filetype-pdf me-1"></i>{{ _('PDF') }}
    </a>
    <button class="btn btn-primary" id="rb-save"><i class="bi bi-save me-1"></i>{{ _('Salvar') }}</button>
  </div>
</div>

<div class="row g-4">
  <!-- Palette / Settings -->
  <div class="col-lg-4">
    <div class="rb-panel p-3 mb-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-semibold">{{ _('Componentes') }}</div>
        <span class="text-muted small">{{ _('Arraste e solte') }}</span>
      </div>

      <div id="rb-palette" class="rb-palette d-grid gap-2">
        <div class="rb-item rb-block" data-type="text" data-title="{{ _('Texto') }}">
          <div class="meta">
            <span class="badge text-bg-secondary">T</span>
            <div>
              <div class="fw-semibold">{{ _('Texto') }}</div>
              <div class="text-muted small">{{ _('Título / parágrafo simples') }}</div>
            </div>
          </div>
          <i class="bi bi-grip-vertical"></i>
        </div>

        <div class="rb-item rb-block" data-type="markdown" data-title="{{ _('Markdown') }}">
          <div class="meta">
            <span class="badge text-bg-secondary">MD</span>
            <div>
              <div class="fw-semibold">{{ _('Markdown') }}</div>
              <div class="text-muted small">{{ _('Texto com formatação') }}</div>
            </div>
          </div>
          <i class="bi bi-grip-vertical"></i>
        </div>

        <div class="rb-item rb-block" data-type="image" data-title="{{ _('Imagem') }}">
          <div class="meta">
            <span class="badge text-bg-secondary">IMG</span>
            <div>
              <div class="fw-semibold">{{ _('Imagem') }}</div>
              <div class="text-muted small">{{ _('Figura / logotipo / screenshot') }}</div>
            </div>
          </div>
          <i class="bi bi-grip-vertical"></i>
        </div>

        <div class="rb-item rb-block" data-type="question" data-title="{{ _('Tabela') }}">
          <div class="meta">
            <span class="badge text-bg-secondary">Q</span>
            <div>
              <div class="fw-semibold">{{ _('Tabela/Gráfico de pergunta') }}</div>
              <div class="text-muted small">{{ _('Reaproveita uma Pergunta salva') }}</div>
            </div>
          </div>
          <i class="bi bi-grip-vertical"></i>
        </div>

        <div class="rb-item rb-block" data-type="field" data-title="{{ _('Campo') }}">
          <div class="meta">
            <span class="badge text-bg-secondary">F</span>
            <div>
              <div class="fw-semibold">{{ _('Campo') }}</div>
              <div class="text-muted small">{{ _('Data / data-hora (sistema)') }}</div>
            </div>
          </div>
          <i class="bi bi-grip-vertical"></i>
        </div>
      </div>

      <hr>

      <div class="fw-semibold mb-2">{{ _('Adicionar pergunta') }}</div>
      <div class="d-flex gap-2">
        <select id="rb-question" class="form-select">
          <option value="">--</option>
          {% for q in questions %}
            <option value="{{ q.id }}">{{ q.name }}</option>
          {% endfor %}
        </select>
        <button class="btn btn-outline-primary" id="rb-add-question" type="button">{{ _('Inserir') }}</button>
      </div>
      <div class="form-text">{{ _('Isso cria um bloco “Pergunta” no detalhe do relatório.') }}</div>

      <hr>

      <div class="fw-semibold mb-2">{{ _('Adicionar imagem') }}</div>
      <div class="d-flex gap-2">
        <input id="rb-image-url" class="form-control" placeholder="{{ _('URL (https://...)') }}" />
        <button class="btn btn-outline-primary" id="rb-add-image" type="button">{{ _('Inserir') }}</button>
      </div>
      <div class="form-text">{{ _('Isso cria um bloco “Imagem” no detalhe do relatório.') }}</div>

      <div class="fw-semibold mb-2">{{ _('Dica') }}</div>
      <div class="text-muted small">
        {{ _('Bandas tipo Crystal/DevExpress: Report Header (1ª página), Page Header (todas), Detail, Page Footer (todas), Report Footer (última). Clique no bloco para editar.') }}
      </div>
    </div>

    

    <div class="rb-panel p-3 mb-4" id="rb-settings-panel">
      <div class="fw-semibold mb-2">{{ _('Configurações') }}</div>
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="rb-setting-page-number" checked />
        <label class="form-check-label" for="rb-setting-page-number">{{ _('Numeração de páginas no PDF') }}</label>
      </div>
      <div class="mb-0">
        <label class="form-label" for="rb-setting-page-label">{{ _('Formato') }}</label>
        <input class="form-control" id="rb-setting-page-label" placeholder="Page {page} / {pages}" value="Page {page} / {pages}" />
        <div class="form-text">{{ _('Use {page} e {pages}.') }}</div>
      </div>
    </div>
<div class="alert alert-info mb-0">
      <div class="fw-semibold">{{ _('Report Builder') }}</div>
      <div class="small">{{ _('Use “Visualizar” para ver o relatório e “PDF” para exportar com cabeçalho/rodapé repetidos e número de página.') }}</div>
    </div>
  </div>

  <!-- Canvas -->
  <div class="col-lg-8">
    <div class="rb-canvas p-3">
      <div class="row g-3">

        <div class="col-12">
          <div class="rb-section">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="rb-section-title">{{ _('Report Header') }}</div>
              <span class="text-muted small">{{ _('Apenas na 1ª página') }}</span>
            </div>
            <div id="rb-report-header" class="rb-dropzone d-grid gap-2">
              <div class="rb-drop-hint">{{ _('Arraste aqui...') }}</div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="rb-section">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="rb-section-title">{{ _('Page Header') }}</div>
              <span class="text-muted small">{{ _('Repete em todas as páginas') }}</span>
            </div>
            <div id="rb-page-header" class="rb-dropzone d-grid gap-2">
              <div class="rb-drop-hint">{{ _('Arraste aqui...') }}</div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="rb-section">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="rb-section-title">{{ _('Detail') }}</div>
              <span class="text-muted small">{{ _('Conteúdo principal') }}</span>
            </div>
            <div id="rb-detail" class="rb-dropzone d-grid gap-2">
              <div class="rb-drop-hint">{{ _('Arraste aqui...') }}</div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="rb-section">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="rb-section-title">{{ _('Page Footer') }}</div>
              <span class="text-muted small">{{ _('Repete em todas as páginas') }}</span>
            </div>
            <div id="rb-page-footer" class="rb-dropzone d-grid gap-2">
              <div class="rb-drop-hint">{{ _('Arraste aqui...') }}</div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="rb-section">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="rb-section-title">{{ _('Report Footer') }}</div>
              <span class="text-muted small">{{ _('Apenas na última página') }}</span>
            </div>
            <div id="rb-report-footer" class="rb-dropzone d-grid gap-2">
              <div class="rb-drop-hint">{{ _('Arraste aqui...') }}</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div id="rb-floating-explorer" class="rb-panel rb-floating-explorer" aria-label="{{ _('Data Explorer') }}">
  <div id="rb-floating-explorer-head" class="rb-floating-head">
    <div class="fw-semibold d-flex align-items-center gap-2">
      <i class="bi bi-diagram-3"></i>
      <span>{{ _('Data Explorer') }}</span>
    </div>
    <div class="d-flex align-items-center gap-1">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="rb-floating-explorer-dock" title="{{ _('Reencaixar') }}"><i class="bi bi-bounding-box"></i></button>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="rb-floating-explorer-collapse" title="{{ _('Minimizar') }}"><i class="bi bi-chevron-down"></i></button>
    </div>
  </div>
  <div class="rb-floating-body">
    <input id="rb-data-search" class="form-control rb-data-search mb-2" placeholder="{{ _('Filtrar tabelas, campos e perguntas...') }}" />

    <div class="rb-data-card mb-2">
      <div class="rb-data-head">
        <div class="fw-semibold small mb-0">{{ _('Tabelas e campos') }}</div>
        <span class="badge text-bg-light border" id="rb-data-tables-count">0</span>
      </div>
      <div id="rb-data-tables" class="p-2 d-grid gap-2">
        <div class="text-muted small">{{ _('Carregando metadados...') }}</div>
      </div>
    </div>

    <div class="rb-data-card mb-2">
      <div class="rb-data-head">
        <div class="fw-semibold small mb-0">{{ _('Perguntas e campos') }}</div>
        <span class="badge text-bg-light border" id="rb-data-questions-count">{{ questions|length }}</span>
      </div>
      <div id="rb-data-questions" class="p-2 d-grid gap-2">
        {% for q in questions %}
          <div class="rb-data-card" data-question-card data-search-text="{{ (q.name ~ ' ' ~ q.id)|lower }}">
            <div class="rb-data-head">
              <div class="small fw-semibold text-truncate" title="{{ q.name }}">{{ q.name }}</div>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-load-question="{{ q.id }}">{{ _('Campos') }}</button>
            </div>
            <div class="rb-data-fields d-none" id="rb-q-fields-{{ q.id }}"></div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>


<!-- Block editor modal -->
<div class="modal fade" id="rb-edit-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rb-edit-modal-title">{{ _('Editar bloco') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Fechar') }}"></button>
      </div>
      <div class="modal-body">
        <form id="rb-edit-form" autocomplete="off">
          <input type="hidden" id="rb-edit-type" />

          <div class="mb-3">
            <label class="form-label" for="rb-edit-title">{{ _('Título') }}</label>
            <input class="form-control" id="rb-edit-title" />
          </div>

          <div class="mb-3" id="rb-edit-text-group">
            <label class="form-label" id="rb-edit-content-label" for="rb-edit-content">{{ _('Texto') }}</label>
            <div class="d-flex flex-wrap gap-1 mb-2 rb-rich-toolbar">
              <button type="button" class="btn btn-sm btn-outline-secondary" data-rb-wrap="**" title="{{ _('Negrito') }}"><i class="bi bi-type-bold"></i></button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-rb-wrap="_" title="{{ _('Itálico') }}"><i class="bi bi-type-italic"></i></button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-rb-wrap="~~" title="{{ _('Riscado') }}"><i class="bi bi-type-strikethrough"></i></button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-rb-prefix="- " title="{{ _('Lista') }}"><i class="bi bi-list-ul"></i></button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-rb-insert="\n---\n" title="{{ _('Separador') }}"><i class="bi bi-hr"></i></button>
            </div>
            <textarea class="form-control" id="rb-edit-content" rows="8"></textarea>
          </div>

          <div class="d-none" id="rb-edit-image-group">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label" for="rb-edit-image-url">{{ _('URL da imagem') }}</label>
                <input class="form-control" id="rb-edit-image-url" placeholder="{{ _('https://...') }}" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-image-alt">{{ _('Texto alternativo (alt)') }}</label>
                <input class="form-control" id="rb-edit-image-alt" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-image-width">{{ _('Largura') }}</label>
                <input class="form-control" id="rb-edit-image-width" placeholder="{{ _('ex.: 300px ou 50%') }}" />
              </div>
              <div class="col-12">
                <label class="form-label" for="rb-edit-image-caption">{{ _('Legenda (opcional)') }}</label>
                <input class="form-control" id="rb-edit-image-caption" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-image-align">{{ _('Alinhamento') }}</label>
                <select class="form-select" id="rb-edit-image-align">
                  <option value="">{{ _('Padrão') }}</option>
                  <option value="left">{{ _('Esquerda') }}</option>
                  <option value="center">{{ _('Centro') }}</option>
                  <option value="right">{{ _('Direita') }}</option>
                </select>
              </div>
              <div class="col-md-6">
                <div class="border rounded-3 p-2 bg-light">
                  <div class="text-muted small mb-1">{{ _('Pré-visualização') }}</div>
                  <div class="d-flex justify-content-center">
                    <img id="rb-edit-image-preview" alt="" style="max-width:100%; max-height:160px; border-radius:.5rem; border:1px solid rgba(0,0,0,.08);" />
                  </div>
                </div>
              </div>
            </div>
            <hr>
          </div>

          <div class="d-none" id="rb-edit-field-group">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-field-kind">{{ _('Tipo de campo') }}</label>
                <select class="form-select" id="rb-edit-field-kind">
                  <option value="date">{{ _('Data') }}</option>
                  <option value="datetime">{{ _('Data e hora') }}</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-field-format">{{ _('Formato') }}</label>
                <input class="form-control" id="rb-edit-field-format" placeholder="dd/MM/yyyy" />
              </div>
            </div>
            <hr>
          </div>

          <div class="d-none" id="rb-edit-question-group">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-q-theme">{{ _('Tema da tabela') }}</label>
                <select class="form-select" id="rb-edit-q-theme">
                  <option value="crystal">Crystal</option>
                  <option value="devexpress">DevExpress</option>
                  <option value="minimal">Minimal</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label" for="rb-edit-q-decimals">{{ _('Decimais') }}</label>
                <input type="number" class="form-control" id="rb-edit-q-decimals" min="0" max="10" step="1" placeholder="2" />
              </div>
              <div class="col-md-3">
                <label class="form-label">{{ _('PDF') }}</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="rb-edit-q-repeat-header" />
                  <label class="form-check-label" for="rb-edit-q-repeat-header">{{ _('Repetir header') }}</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="rb-edit-q-zebra" />
                  <label class="form-check-label" for="rb-edit-q-zebra">{{ _('Zebra (linhas alternadas)') }}</label>
                </div>
              </div>

              <div class="col-12">
                <div class="fw-semibold small text-muted text-uppercase">{{ _('Grouping') }}</div>
              </div>

              <div class="col-md-6">
                <label class="form-label" for="rb-edit-q-group-by">{{ _('Agrupar por coluna') }}</label>
                <input class="form-control" id="rb-edit-q-group-by" placeholder="{{ _('Ex.: country') }}" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-q-group-label">{{ _('Formato do cabeçalho do grupo') }}</label>
                <input class="form-control" id="rb-edit-q-group-label" placeholder="{{ _('{group}') }}" />
                <div class="form-text">{{ _('Use {group}. Ex.: Região: {group}') }}</div>
              </div>
              <div class="col-md-6">
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="rb-edit-q-group-count" />
                  <label class="form-check-label" for="rb-edit-q-group-count">{{ _('Mostrar contagem por grupo') }}</label>
                </div>
              </div>

              <div class="col-12">
                <div class="fw-semibold small text-muted text-uppercase">{{ _('Sorting') }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-q-sort-by">{{ _('Ordenar por coluna') }}</label>
                <input class="form-control" id="rb-edit-q-sort-by" placeholder="{{ _('Ex.: total_amount') }}" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-q-sort-dir">{{ _('Direção') }}</label>
                <select class="form-select" id="rb-edit-q-sort-dir">
                  <option value="asc">{{ _('Ascendente') }}</option>
                  <option value="desc">{{ _('Descendente') }}</option>
                </select>
              </div>
            </div>
            <hr>
          </div>

          <div class="d-none" id="rb-edit-data-field-group">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label" for="rb-edit-data-binding">{{ _('Origem') }}</label>
                <input class="form-control" id="rb-edit-data-binding" readonly />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-data-empty">{{ _('Texto quando vazio') }}</label>
                <input class="form-control" id="rb-edit-data-empty" placeholder="{{ _('(vazio)') }}" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-data-format">{{ _('Formato (opcional)') }}</label>
                <input class="form-control" id="rb-edit-data-format" placeholder="{{ _('Ex.: .2f, dd/MM/yyyy') }}" />
              </div>
              <div class="col-md-6">
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="rb-edit-data-group-key" />
                  <label class="form-check-label" for="rb-edit-data-group-key">{{ _('Utiliser ce champ comme clé de groupe') }}</label>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-data-group-label">{{ _('Libellé du groupe') }}</label>
                <input class="form-control" id="rb-edit-data-group-label" placeholder="{{ _('Groupe: {group}') }}" />
                <div class="form-text">{{ _('Utilisez {group}.') }}</div>
              </div>
            </div>
            <hr>
          </div>

          <div class="fw-semibold mb-2">{{ _('Estilo') }}</div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="rb-edit-color">{{ _('Cor do texto') }}</label>
              <div class="d-flex flex-wrap gap-2 mb-2 rb-color-palette" data-target="rb-edit-color">
                <button type="button" class="btn btn-sm btn-outline-secondary rb-swatch" data-color="">{{ _('Sem') }}</button>
                <button type="button" class="rb-swatch" data-color="#111827" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#111827"></button>
                <button type="button" class="rb-swatch" data-color="#374151" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#374151"></button>
                <button type="button" class="rb-swatch" data-color="#6b7280" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#6b7280"></button>
                <button type="button" class="rb-swatch" data-color="#0d6efd" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#0d6efd"></button>
                <button type="button" class="rb-swatch" data-color="#198754" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#198754"></button>
                <button type="button" class="rb-swatch" data-color="#dc3545" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#dc3545"></button>
                <button type="button" class="rb-swatch" data-color="#f59e0b" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#f59e0b"></button>
              </div>
              <div class="input-group">
                <span class="input-group-text">#</span>
                <input class="form-control" id="rb-edit-color" placeholder="{{ _('hex ou vazio') }}" />
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="rb-edit-bg">{{ _('Cor de fundo') }}</label>
              <div class="d-flex flex-wrap gap-2 mb-2 rb-color-palette" data-target="rb-edit-bg">
                <button type="button" class="btn btn-sm btn-outline-secondary rb-swatch" data-color="">{{ _('Sem') }}</button>
                <button type="button" class="rb-swatch" data-color="#ffffff" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#ffffff"></button>
                <button type="button" class="rb-swatch" data-color="#f8f9fa" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#f8f9fa"></button>
                <button type="button" class="rb-swatch" data-color="#e9ecef" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#e9ecef"></button>
                <button type="button" class="rb-swatch" data-color="#0d6efd" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#0d6efd"></button>
                <button type="button" class="rb-swatch" data-color="#198754" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#198754"></button>
                <button type="button" class="rb-swatch" data-color="#dc3545" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#dc3545"></button>
                <button type="button" class="rb-swatch" data-color="#111827" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#111827"></button>
              </div>
              <div class="input-group">
                <span class="input-group-text">#</span>
                <input class="form-control" id="rb-edit-bg" placeholder="{{ _('hex ou vazio') }}" />
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label" for="rb-edit-align">{{ _('Alinhamento') }}</label>
            <select class="form-select" id="rb-edit-align">
              <option value="">{{ _('Padrão') }}</option>
              <option value="left">{{ _('Esquerda') }}</option>
              <option value="center">{{ _('Centro') }}</option>
              <option value="right">{{ _('Direita') }}</option>
            </select>
          </div>

          <div class="row g-3 mt-0">
            <div class="col-md-4">
              <label class="form-label" for="rb-edit-font-size">{{ _('Tamanho da fonte (px)') }}</label>
              <input type="number" min="8" max="72" step="1" class="form-control" id="rb-edit-font-size" placeholder="14" />
            </div>
            <div class="col-md-8 d-flex align-items-end gap-3 pb-1">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="rb-edit-font-bold" />
                <label class="form-check-label" for="rb-edit-font-bold">{{ _('Negrito') }}</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="rb-edit-font-italic" />
                <label class="form-check-label" for="rb-edit-font-italic">{{ _('Itálico') }}</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="rb-edit-font-underline" />
                <label class="form-check-label" for="rb-edit-font-underline">{{ _('Sublinhado') }}</label>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancelar') }}</button>
        <button type="button" class="btn btn-primary" id="rb-edit-save">{{ _('Aplicar') }}</button>
      </div>
    </div>
  </div>
</div>


<script>
  window.__RB = {
    reportId: {{ report.id }},
    sourceId: {{ source.id }},
    apiUrl: "{{ url_for('portal.api_report_get', report_id=report.id) }}",
    saveUrl: "{{ url_for('portal.api_report_save', report_id=report.id) }}",
    sourceSchemaUrl: "{{ url_for('portal.api_source_schema', source_id=source.id) }}",
    csrfToken: "{{ csrf_token() }}",
  };
</script>
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="{{ url_for('static', filename='portal/report_builder.js') }}"></script>
{% endblock %}
