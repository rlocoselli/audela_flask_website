{% extends "portal/layout.html" %}
{% set title = _('Report Builder') %}

{% block head_extra %}
  {{ super() }}
  <style>
    .rb-panel { border:1px solid var(--bs-border-color); border-radius: .75rem; background: var(--bs-body-bg); }
    .rb-palette .rb-item { cursor: grab; user-select:none; }
    .rb-canvas { min-height: 620px; background: #f8f9fa; border:1px dashed var(--bs-border-color); border-radius: .75rem; }
    .rb-section { background: #fff; border:1px solid var(--bs-border-color); border-radius: .75rem; padding: .75rem; }
    .rb-section-title { font-size: .85rem; text-transform: uppercase; letter-spacing: .04em; color: var(--bs-secondary-color); }
    .rb-block { border:1px solid var(--bs-border-color); border-radius: .75rem; background: #fff; padding: .6rem .75rem; display:flex; align-items:center; justify-content-between; gap:.6rem; }
    .rb-block .meta { display:flex; align-items:center; gap:.5rem; }
    .rb-block .badge { font-weight:600; }
    .rb-drop-hint { color: var(--bs-secondary-color); font-size:.9rem; }
    .rb-color-palette .rb-swatch { cursor: pointer; }
    .rb-color-palette .rb-swatch { padding:0; }
    .rb-color-palette .rb-swatch:not(.btn) { border:none; }
  </style>
{% endblock %}

{% block portal_content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h4 class="mb-0">{{ report.name }}</h4>
    <div class="text-muted small">{{ _('Fonte') }}: {{ source.name }} ({{ source.type }})</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('portal.reports_list') }}"><i class="bi bi-arrow-left me-1"></i>{{ _('Voltar') }}</a>
    <a class="btn btn-outline-secondary" target="_blank" href="{{ url_for('portal.report_view', report_id=report.id) }}">
      <i class="bi bi-eye me-1"></i>{{ _('Visualizar') }}
    </a>
    <a class="btn btn-outline-secondary" href="{{ url_for('portal.report_pdf', report_id=report.id) }}">
      <i class="bi bi-filetype-pdf me-1"></i>{{ _('PDF') }}
    </a>
    <button class="btn btn-primary" id="rb-save"><i class="bi bi-save me-1"></i>{{ _('Salvar') }}</button>
  </div>
</div>

<div class="row g-4">
  <!-- Palette / Settings -->
  <div class="col-lg-4">
    <div class="rb-panel p-3 mb-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-semibold">{{ _('Componentes') }}</div>
        <span class="text-muted small">{{ _('Arraste e solte') }}</span>
      </div>

      <div id="rb-palette" class="rb-palette d-grid gap-2">
        <div class="rb-item rb-block" data-type="text" data-title="{{ _('Texto') }}">
          <div class="meta">
            <span class="badge text-bg-secondary">T</span>
            <div>
              <div class="fw-semibold">{{ _('Texto') }}</div>
              <div class="text-muted small">{{ _('Título / parágrafo simples') }}</div>
            </div>
          </div>
          <i class="bi bi-grip-vertical"></i>
        </div>

        <div class="rb-item rb-block" data-type="markdown" data-title="{{ _('Markdown') }}">
          <div class="meta">
            <span class="badge text-bg-secondary">MD</span>
            <div>
              <div class="fw-semibold">{{ _('Markdown') }}</div>
              <div class="text-muted small">{{ _('Texto com formatação') }}</div>
            </div>
          </div>
          <i class="bi bi-grip-vertical"></i>
        </div>

<div class="rb-item rb-block" data-type="image" data-title="{{ _('Imagem') }}">
  <div class="meta">
    <span class="badge text-bg-secondary">IMG</span>
    <div>
      <div class="fw-semibold">{{ _('Imagem') }}</div>
      <div class="text-muted small">{{ _('Figura / logotipo / screenshot') }}</div>
    </div>
  </div>
  <i class="bi bi-grip-vertical"></i>
</div>

        <div class="rb-item rb-block" data-type="question" data-title="{{ _('Tabela') }}">
          <div class="meta">
            <span class="badge text-bg-secondary">Q</span>
            <div>
              <div class="fw-semibold">{{ _('Tabela/Gráfico de pergunta') }}</div>
              <div class="text-muted small">{{ _('Reaproveita uma Pergunta salva') }}</div>
            </div>
          </div>
          <i class="bi bi-grip-vertical"></i>
        </div>
      </div>

      <hr>

      <div class="fw-semibold mb-2">{{ _('Adicionar pergunta') }}</div>
      <div class="d-flex gap-2">
        <select id="rb-question" class="form-select">
          <option value="">--</option>
          {% for q in questions %}
            <option value="{{ q.id }}">{{ q.name }}</option>
          {% endfor %}
        </select>
        <button class="btn btn-outline-primary" id="rb-add-question" type="button">{{ _('Inserir') }}</button>
      </div>
      <div class="form-text">{{ _('Isso cria um bloco “Pergunta” no corpo do relatório.') }}</div>


<hr>

<div class="fw-semibold mb-2">{{ _('Adicionar imagem') }}</div>
<div class="d-flex gap-2">
  <input id="rb-image-url" class="form-control" placeholder="{{ _('URL (https://...)') }}" />
  <button class="btn btn-outline-primary" id="rb-add-image" type="button">{{ _('Inserir') }}</button>
</div>
<div class="form-text">{{ _('Isso cria um bloco “Imagem” no corpo do relatório.') }}</div>

      <hr>

      <div class="fw-semibold mb-2">{{ _('Dica') }}</div>
      <div class="text-muted small">
        {{ _('Arraste componentes para Header/Body/Footer. Clique no bloco para editar. Salve para persistir o layout.') }}
      </div>
    </div>

    <div class="alert alert-info mb-0">
      <div class="fw-semibold">{{ _('Report Builder') }}</div>
      <div class="small">{{ _('Dica: use “Visualizar” para ver o relatório renderizado e “PDF” para exportar.') }}</div>
    </div>
  </div>

  <!-- Canvas -->
  <div class="col-lg-8">
    <div class="rb-canvas p-3">
      <div class="row g-3">
        <div class="col-12">
          <div class="rb-section">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="rb-section-title">{{ _('Cabeçalho') }}</div>
              <span class="text-muted small">{{ _('Topo do relatório') }}</span>
            </div>
            <div id="rb-header" class="rb-dropzone d-grid gap-2">
              <div class="rb-drop-hint">{{ _('Arraste aqui...') }}</div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="rb-section">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="rb-section-title">{{ _('Corpo') }}</div>
              <span class="text-muted small">{{ _('Conteúdo principal') }}</span>
            </div>
            <div id="rb-body" class="rb-dropzone d-grid gap-2">
              <div class="rb-drop-hint">{{ _('Arraste aqui...') }}</div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="rb-section">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="rb-section-title">{{ _('Rodapé') }}</div>
              <span class="text-muted small">{{ _('Rodapé') }}</span>
            </div>
            <div id="rb-footer" class="rb-dropzone d-grid gap-2">
              <div class="rb-drop-hint">{{ _('Arraste aqui...') }}</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>


<!-- Block editor modal -->
<div class="modal fade" id="rb-edit-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rb-edit-modal-title">{{ _('Editar bloco') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Fechar') }}"></button>
      </div>
      <div class="modal-body">
        <form id="rb-edit-form" autocomplete="off">
          <input type="hidden" id="rb-edit-type" />
          <div class="mb-3">
            <label class="form-label" for="rb-edit-title">{{ _('Título') }}</label>
            <input class="form-control" id="rb-edit-title" />
          </div>

          <div class="mb-3" id="rb-edit-text-group">
            <label class="form-label" id="rb-edit-content-label" for="rb-edit-content">{{ _('Texto') }}</label>
            <textarea class="form-control" id="rb-edit-content" rows="8"></textarea>
          </div>

          <div class="d-none" id="rb-edit-image-group">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label" for="rb-edit-image-url">{{ _('URL da imagem') }}</label>
                <input class="form-control" id="rb-edit-image-url" placeholder="{{ _('https://...') }}" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-image-alt">{{ _('Texto alternativo (alt)') }}</label>
                <input class="form-control" id="rb-edit-image-alt" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-image-width">{{ _('Largura') }}</label>
                <input class="form-control" id="rb-edit-image-width" placeholder="{{ _('ex.: 300px ou 50%') }}" />
              </div>
              <div class="col-12">
                <label class="form-label" for="rb-edit-image-caption">{{ _('Legenda (opcional)') }}</label>
                <input class="form-control" id="rb-edit-image-caption" />
              </div>
              <div class="col-md-6">
                <label class="form-label" for="rb-edit-image-align">{{ _('Alinhamento') }}</label>
                <select class="form-select" id="rb-edit-image-align">
                  <option value="">{{ _('Padrão') }}</option>
                  <option value="left">{{ _('Esquerda') }}</option>
                  <option value="center">{{ _('Centro') }}</option>
                  <option value="right">{{ _('Direita') }}</option>
                </select>
              </div>
              <div class="col-md-6">
                <div class="border rounded-3 p-2 bg-light">
                  <div class="text-muted small mb-1">{{ _('Pré-visualização') }}</div>
                  <div class="d-flex justify-content-center">
                    <img id="rb-edit-image-preview" alt="" style="max-width:100%; max-height:160px; border-radius:.5rem; border:1px solid rgba(0,0,0,.08);" />
                  </div>
                </div>
              </div>
            </div>
            <hr>
          </div>

          <div class="fw-semibold mb-2">{{ _('Estilo') }}</div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="rb-edit-color">{{ _('Cor do texto') }}</label>
              <div class="d-flex flex-wrap gap-2 mb-2 rb-color-palette" data-target="rb-edit-color">
                <button type="button" class="btn btn-sm btn-outline-secondary rb-swatch" data-color="">{{ _('Sem') }}</button>
                <button type="button" class="rb-swatch" data-color="#111827" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#111827"></button>
                <button type="button" class="rb-swatch" data-color="#374151" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#374151"></button>
                <button type="button" class="rb-swatch" data-color="#6b7280" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#6b7280"></button>
                <button type="button" class="rb-swatch" data-color="#0d6efd" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#0d6efd"></button>
                <button type="button" class="rb-swatch" data-color="#198754" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#198754"></button>
                <button type="button" class="rb-swatch" data-color="#dc3545" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#dc3545"></button>
                <button type="button" class="rb-swatch" data-color="#f59e0b" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#f59e0b"></button>
              </div>
              <div class="input-group">
                <span class="input-group-text">#</span>
                <input class="form-control" id="rb-edit-color" placeholder="{{ _('hex ou vazio') }}" />
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="rb-edit-bg">{{ _('Cor de fundo') }}</label>
              <div class="d-flex flex-wrap gap-2 mb-2 rb-color-palette" data-target="rb-edit-bg">
                <button type="button" class="btn btn-sm btn-outline-secondary rb-swatch" data-color="">{{ _('Sem') }}</button>
                <button type="button" class="rb-swatch" data-color="#ffffff" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#ffffff"></button>
                <button type="button" class="rb-swatch" data-color="#f8f9fa" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#f8f9fa"></button>
                <button type="button" class="rb-swatch" data-color="#e9ecef" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#e9ecef"></button>
                <button type="button" class="rb-swatch" data-color="#0d6efd" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#0d6efd"></button>
                <button type="button" class="rb-swatch" data-color="#198754" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#198754"></button>
                <button type="button" class="rb-swatch" data-color="#dc3545" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#dc3545"></button>
                <button type="button" class="rb-swatch" data-color="#111827" style="width:26px;height:26px;border-radius:.5rem;border:1px solid var(--bs-border-color);background:#111827"></button>
              </div>
              <div class="input-group">
                <span class="input-group-text">#</span>
                <input class="form-control" id="rb-edit-bg" placeholder="{{ _('hex ou vazio') }}" />
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label" for="rb-edit-align">{{ _('Alinhamento') }}</label>
            <select class="form-select" id="rb-edit-align">
              <option value="">{{ _('Padrão') }}</option>
              <option value="left">{{ _('Esquerda') }}</option>
              <option value="center">{{ _('Centro') }}</option>
              <option value="right">{{ _('Direita') }}</option>
            </select>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancelar') }}</button>
        <button type="button" class="btn btn-primary" id="rb-edit-save">{{ _('Aplicar') }}</button>
      </div>
    </div>
  </div>
</div>


<script>
  window.__RB = {
    reportId: {{ report.id }},
    apiUrl: "{{ url_for('portal.api_report_get', report_id=report.id) }}",
    saveUrl: "{{ url_for('portal.api_report_save', report_id=report.id) }}",
    csrfToken: "{{ csrf_token() }}",
  };
</script>
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="{{ url_for('static', filename='portal/report_builder.js') }}"></script>
{% endblock %}
