{% extends "portal/layout.html" %}
{% set title = report.name %}

{% block head_extra %}
  {{ super() }}
  <style>
    .rp-floating-filters {
      position: fixed;
      top: 110px;
      right: 18px;
      width: min(420px, calc(100vw - 24px));
      max-height: calc(100vh - 130px);
      z-index: 1040;
      box-shadow: var(--bs-box-shadow-sm);
      border: 1px solid var(--bs-border-color);
      border-radius: .75rem;
      background: var(--bs-body-bg);
      display: flex;
      flex-direction: column;
    }
    .rp-floating-filters .rp-floating-head {
      cursor: move;
      user-select: none;
      border-bottom: 1px solid var(--bs-border-color);
      padding: .55rem .7rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
    }
    .rp-floating-filters .rp-floating-body { overflow: auto; padding: .7rem; }
    .rp-floating-filters.is-collapsed .rp-floating-body { display: none; }
    @media (max-width: 991.98px) {
      .rp-floating-filters {
        right: 8px;
        left: 8px;
        width: auto;
        top: auto;
        bottom: 8px;
        max-height: 60vh;
      }
      .rp-floating-filters .rp-floating-head { cursor: default; }
    }
  </style>
{% endblock %}

{% block portal_content %}
<div class="container-fluid px-0">

  <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">{{ report.name }}</h1>
      <div class="text-secondary small"><i class="bi bi-database me-1"></i>{{ source.name }} ({{ source.type }})</div>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-outline-secondary btn-sm" id="rp-floating-filters-toggle" type="button">
        <i class="bi bi-funnel me-1"></i> {{ _('Filtres flottants') }}
      </button>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('portal.report_builder', report_id=report.id) }}">
        <i class="bi bi-pencil"></i> {{ _('Editar') }}
      </a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('portal.reports_list') }}">
        <i class="bi bi-arrow-left"></i> {{ _('Voltar') }}
      </a>
      <a class="btn btn-primary btn-sm" href="{{ url_for('portal.report_pdf', report_id=report.id) }}">
        <i class="bi bi-filetype-pdf"></i> {{ _('Exportar PDF') }}
      </a>
    </div>
  </div>

  {# Prefer new banded structure; keep backward compat #}
  {% set b = bands if bands is defined else (layout.get('bands') or {}) %}
  {% if not b %}
    {% set sections = (layout.sections or layout.get('sections') or {}) %}
    {% set b = {
      'report_header': [],
      'page_header': sections.get('header') or [],
      'detail': sections.get('body') or [],
      'page_footer': sections.get('footer') or [],
      'report_footer': []
    } %}
  {% endif %}

  {% set order = ['report_header','page_header','detail','page_footer','report_footer'] %}

  <div class="card border-0 shadow-sm rounded-4 mb-3">
    <div class="card-body">
      <div class="row g-4">

        {% for band_name in order %}
          {% set blocks = b.get(band_name) or [] %}
          {% if blocks %}
            <div class="col-12">
              <div class="d-grid gap-3">

                {% for blk in blocks %}
                  {% set btype = (blk.type or blk.get('type') or '') %}
                  {% set st = (blk.style or blk.get('style') or {}) %}
                  {% set color = st.get('color') if st is mapping else '' %}
                  {% set bg = st.get('background') if st is mapping else '' %}
                  {% set align = st.get('align') if st is mapping else '' %}
                  {% set font_size = st.get('font_size') if st is mapping else '' %}
                  {% set bold = st.get('bold') if st is mapping else False %}
                  {% set italic = st.get('italic') if st is mapping else False %}
                  {% set underline = st.get('underline') if st is mapping else False %}
                  {% set style_inline = ('color:' ~ color ~ ';') if color else '' %}
                  {% set style_inline = style_inline ~ (('background:' ~ bg ~ ';') if bg else '') %}
                  {% set style_inline = style_inline ~ (('text-align:' ~ align ~ ';') if align else '') %}
                  {% set style_inline = style_inline ~ (('font-size:' ~ font_size ~ 'px;') if font_size else '') %}
                  {% set style_inline = style_inline ~ ('font-weight:700;' if bold else '') %}
                  {% set style_inline = style_inline ~ ('font-style:italic;' if italic else '') %}
                  {% set style_inline = style_inline ~ ('text-decoration:underline;' if underline else '') %}

                  {% if btype in ['text','markdown'] %}
                    <div class="border rounded-4 p-3 bg-body" style="{{ style_inline }}">
                      {% if blk.title or blk.get('title') %}
                        <div class="fw-semibold mb-1">{{ blk.title or blk.get('title') }}</div>
                      {% endif %}
                      <div class="text-secondary" style="white-space: pre-wrap;{% if color %} color: {{ color }};{% endif %}">
                        {{ blk.content or blk.get('content') or blk.text or blk.get('text') }}
                      </div>
                    </div>

                  {% elif btype == 'field' %}
                    <div class="border rounded-4 p-3 bg-body" style="{{ style_inline }}">
                      {% if blk.title or blk.get('title') %}
                        <div class="fw-semibold mb-1">{{ blk.title or blk.get('title') }}</div>
                      {% endif %}
                      <div class="text-secondary" {% if color %}style="color: {{ color }};"{% endif %}>
                        {{ blk.value or blk.get('value') }}
                      </div>
                    </div>

                  {% elif btype == 'data_field' %}
                    {% set key = blk._key or blk.get('_key') or '' %}
                    {% set d = blocks_data.get(key) %}
                    {% set field_name = (blk.title or blk.get('title') or key or 'value') %}
                    {% set field_value = ((d.value if d else '') or '') %}
                    <div class="border rounded-4 p-3 bg-body" style="{{ style_inline }}" data-rp-field="{{ field_name }}" data-rp-value="{{ field_value }}">
                      {% if blk.title or blk.get('title') %}
                        <div class="fw-semibold mb-1">{{ blk.title or blk.get('title') }}</div>
                      {% endif %}
                      {% if d and d.error %}
                        <div class="alert alert-danger py-2 mb-0">{{ d.error }}</div>
                      {% else %}
                        <div class="text-secondary" {% if color %}style="color: {{ color }};"{% endif %}>
                          {{ (d.value if d else '') or '' }}
                        </div>
                      {% endif %}
                    </div>

                  {% elif btype == 'data_rowset' %}
                    {% set key = blk._key or blk.get('_key') or '' %}
                    {% set d = blocks_data.get(key) %}
                    {% set cfg = blk.config if blk.config is mapping else (blk.get('config') if blk.get('config') is mapping else {}) %}
                    {% set tcfg = cfg.get('table') if cfg.get('table') is mapping else {} %}
                    {% set zebra = (tcfg.get('zebra') or False) %}
                    {% set header_bg = (tcfg.get('header_bg') or '') %}
                    <div class="border rounded-4 p-3 bg-body" style="{{ style_inline }}">
                      {% if blk.title or blk.get('title') %}
                        <div class="fw-semibold mb-2">{{ blk.title or blk.get('title') }}</div>
                      {% endif %}
                      {% if d and d.error %}
                        <div class="alert alert-danger py-2 mb-0">{{ d.error }}</div>
                      {% elif d and d.groups %}
                        <div class="d-grid gap-3">
                          {% for g in d.groups %}
                            <div class="border rounded-3 p-2">
                              <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="fw-semibold">{{ g.label }}</div>
                                {% if d.group_count %}
                                  <span class="badge text-bg-light border">{{ g.count }}</span>
                                {% endif %}
                              </div>
                              <div class="table-responsive">
                                <table class="table table-sm align-middle mb-0 {% if zebra %}table-striped{% endif %}">
                                  <thead>
                                    <tr {% if header_bg %}style="background: {{ header_bg }};"{% endif %}>
                                      {% for c in d.columns %}
                                        {% set cs = (d.column_styles[loop.index0] if d.column_styles is defined and d.column_styles and loop.index0 < d.column_styles|length else {}) %}
                                        {% set cstyle = '' %}
                                        {% if cs %}
                                          {% set cstyle = (('color:' ~ cs.color ~ ';') if cs.color else '')
                                            ~ (('background:' ~ cs.background ~ ';') if cs.background else '')
                                            ~ (('text-align:' ~ cs.align ~ ';') if cs.align else '')
                                            ~ (('font-size:' ~ cs.font_size ~ 'px;') if cs.font_size else '')
                                            ~ ('font-weight:700;' if cs.bold else '')
                                            ~ ('font-style:italic;' if cs.italic else '')
                                            ~ ('text-decoration:underline;' if cs.underline else '') %}
                                        {% endif %}
                                        <th {% if cstyle %}style="{{ cstyle }}"{% endif %}>{{ c }}</th>
                                      {% endfor %}
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {% for r in g.rows %}
                                      <tr>
                                        {% for cell in r %}
                                          {% set cs = (d.column_styles[loop.index0] if d.column_styles is defined and d.column_styles and loop.index0 < d.column_styles|length else {}) %}
                                          {% set cstyle = '' %}
                                          {% if cs %}
                                            {% set cstyle = (('color:' ~ cs.color ~ ';') if cs.color else '')
                                              ~ (('background:' ~ cs.background ~ ';') if cs.background else '')
                                              ~ (('text-align:' ~ cs.align ~ ';') if cs.align else '')
                                              ~ (('font-size:' ~ cs.font_size ~ 'px;') if cs.font_size else '')
                                              ~ ('font-weight:700;' if cs.bold else '')
                                              ~ ('font-style:italic;' if cs.italic else '')
                                              ~ ('text-decoration:underline;' if cs.underline else '') %}
                                          {% endif %}
                                          <td {% if cstyle %}style="{{ cstyle }}"{% endif %}>{{ cell }}</td>
                                        {% endfor %}
                                      </tr>
                                    {% endfor %}
                                  </tbody>
                                </table>
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      {% elif d and d.rows %}
                        <div class="table-responsive">
                          <table class="table table-sm align-middle mb-0 {% if zebra %}table-striped{% endif %}">
                            <thead>
                              <tr {% if header_bg %}style="background: {{ header_bg }};"{% endif %}>
                                {% for c in d.columns %}
                                  {% set cs = (d.column_styles[loop.index0] if d.column_styles is defined and d.column_styles and loop.index0 < d.column_styles|length else {}) %}
                                  {% set cstyle = '' %}
                                  {% if cs %}
                                    {% set cstyle = (('color:' ~ cs.color ~ ';') if cs.color else '')
                                      ~ (('background:' ~ cs.background ~ ';') if cs.background else '')
                                      ~ (('text-align:' ~ cs.align ~ ';') if cs.align else '')
                                      ~ (('font-size:' ~ cs.font_size ~ 'px;') if cs.font_size else '')
                                      ~ ('font-weight:700;' if cs.bold else '')
                                      ~ ('font-style:italic;' if cs.italic else '')
                                      ~ ('text-decoration:underline;' if cs.underline else '') %}
                                  {% endif %}
                                  <th {% if cstyle %}style="{{ cstyle }}"{% endif %}>{{ c }}</th>
                                {% endfor %}
                              </tr>
                            </thead>
                            <tbody>
                              {% for r in d.rows %}
                                <tr>
                                  {% for cell in r %}
                                    {% set cs = (d.column_styles[loop.index0] if d.column_styles is defined and d.column_styles and loop.index0 < d.column_styles|length else {}) %}
                                    {% set cstyle = '' %}
                                    {% if cs %}
                                      {% set cstyle = (('color:' ~ cs.color ~ ';') if cs.color else '')
                                        ~ (('background:' ~ cs.background ~ ';') if cs.background else '')
                                        ~ (('text-align:' ~ cs.align ~ ';') if cs.align else '')
                                        ~ (('font-size:' ~ cs.font_size ~ 'px;') if cs.font_size else '')
                                        ~ ('font-weight:700;' if cs.bold else '')
                                        ~ ('font-style:italic;' if cs.italic else '')
                                        ~ ('text-decoration:underline;' if cs.underline else '') %}
                                    {% endif %}
                                    <td {% if cstyle %}style="{{ cstyle }}"{% endif %}>{{ cell }}</td>
                                  {% endfor %}
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      {% else %}
                        <div class="text-secondary small">{{ _('Sem linhas retornadas.') }}</div>
                      {% endif %}
                    </div>

                  {% elif btype == 'image' %}
                    {% set align2 = (blk.align or blk.get('align') or align) %}
                    {% set width = blk.width or blk.get('width') or '' %}
                    {% set url = blk.url or blk.get('url') or blk.image_url or blk.get('image_url') or '' %}
                    {% set alt = blk.alt or blk.get('alt') or '' %}
                    {% set caption = blk.caption or blk.get('caption') or '' %}
                    {% set style_inline2 = (('background:' ~ bg ~ ';') if bg else '') ~ (('text-align:' ~ align2 ~ ';') if align2 else '') %}

                    <div class="border rounded-4 p-3 bg-body" style="{{ style_inline2 }}">
                      {% if blk.title or blk.get('title') %}
                        <div class="fw-semibold mb-2" {% if color %}style="color: {{ color }};"{% endif %}>
                          {{ blk.title or blk.get('title') }}
                        </div>
                      {% endif %}

                      {% if url %}
                        <img src="{{ url }}" alt="{{ alt }}"
                             style="max-width:100%; {% if width %}width: {{ width }};{% endif %} border-radius: .5rem;" />
                      {% else %}
                        <div class="text-secondary small">{{ _('Imagem não disponível') }}</div>
                      {% endif %}

                      {% if caption %}
                        <div class="text-secondary small mt-2" {% if color %}style="color: {{ color }};"{% endif %}>
                          {{ caption }}
                        </div>
                      {% endif %}
                    </div>

                  {% elif btype == 'question' %}
                    {% set key = blk._key or blk.get('_key') or '' %}
                    {% set cfg = blk.config if blk.config is mapping else (blk.get('config') if blk.get('config') is mapping else {}) %}
                    {% set tcfg = cfg.get('table') if cfg.get('table') is mapping else {} %}
                    {% set theme = (tcfg.get('theme') or 'crystal') %}
                    {% set theme_label = _('Standard') if theme == 'crystal' else (_('Pro') if theme == 'professional' else (_('Léger') if theme == 'minimal' else theme)) %}
                    {% set zebra = (tcfg.get('zebra') or False) %}
                    {% set header_bg = (tcfg.get('header_bg') or '') %}

                    {% set qid = (blk.question_id or blk.get('question_id') or 0)|int %}
                    {% set q = questions.get(qid) %}
                    {% set d = blocks_data.get(key) %}

                    <div class="border rounded-4 p-3 bg-body">
                      <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                        <div class="fw-semibold"><i class="bi bi-ui-checks me-1"></i>{{ q.name if q else ('Pergunta #' ~ qid) }}</div>
                        <span class="badge text-bg-light border">{{ theme_label }}</span>
                      </div>

                      {% if d and d.error %}
                        <div class="alert alert-danger py-2 mb-0">{{ d.error }}</div>
                      {% elif d and d.groups %}
                        <div class="d-grid gap-3">
                          {% for g in d.groups %}
                            <div class="border rounded-3 p-2">
                              <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="fw-semibold">{{ g.label }}</div>
                                {% if d.group_count %}
                                  <span class="badge text-bg-light border">{{ g.count }}</span>
                                {% endif %}
                              </div>
                              {% if g.rows %}
                                <div class="table-responsive">
                                  <table class="table table-sm align-middle mb-0 {% if zebra %}table-striped{% endif %}">
                                    <thead>
                                      <tr {% if header_bg %}style="background: {{ header_bg }};"{% endif %}>
                                        {% for c in d.columns %}<th>{{ c }}</th>{% endfor %}
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {% for r in g.rows %}
                                        <tr>
                                          {% for cell in r %}<td>{{ cell }}</td>{% endfor %}
                                        </tr>
                                      {% endfor %}
                                    </tbody>
                                  </table>
                                </div>
                                {% if g.subtotal %}
                                  <div class="small fw-semibold text-end mt-2">{{ g.subtotal }}</div>
                                {% endif %}
                              {% else %}
                                <div class="text-secondary small">{{ _('Sem linhas neste grupo.') }}</div>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                        {% if d.grand_total %}
                          <div class="small fw-bold text-end mt-2">{{ d.grand_total }}</div>
                        {% endif %}
                        {% if d.footer_item_count %}
                          <div class="small text-end mt-1">{{ d.footer_item_count }}</div>
                        {% endif %}
                      {% elif d and d.rows %}
                        <div class="table-responsive">
                          <table class="table table-sm align-middle mb-0 {% if zebra %}table-striped{% endif %}">
                            <thead>
                              <tr {% if header_bg %}style="background: {{ header_bg }};"{% endif %}>
                                {% for c in d.columns %}<th>{{ c }}</th>{% endfor %}
                              </tr>
                            </thead>
                            <tbody>
                              {% for r in d.rows %}
                                <tr>
                                  {% for cell in r %}<td>{{ cell }}</td>{% endfor %}
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                        {% if d.grand_total %}
                          <div class="small fw-bold text-end mt-2">{{ d.grand_total }}</div>
                        {% endif %}
                        {% if d.footer_item_count %}
                          <div class="small text-end mt-1">{{ d.footer_item_count }}</div>
                        {% endif %}
                      {% else %}
                        <div class="text-secondary small">{{ _('Sem linhas retornadas.') }}</div>
                      {% endif %}
                    </div>
                  {% endif %}

                {% endfor %}

              </div>
            </div>
          {% endif %}
        {% endfor %}

      </div>
    </div>
  </div>

  <div id="rp-floating-filters" class="rp-floating-filters" aria-label="{{ _('Filtres flottants') }}">
    <div id="rp-floating-filters-head" class="rp-floating-head">
      <div class="fw-semibold d-flex align-items-center gap-2">
        <i class="bi bi-funnel"></i>
        <span>{{ _('Filtres') }}</span>
      </div>
      <div class="d-flex align-items-center gap-1">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="rp-floating-filters-dock" title="{{ _('Reencaixar') }}"><i class="bi bi-bounding-box"></i></button>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="rp-floating-filters-collapse" title="{{ _('Minimizar') }}"><i class="bi bi-chevron-down"></i></button>
      </div>
    </div>
    <div class="rp-floating-body">
      <div class="row g-2 align-items-end">
        <div class="col-12">
          <label class="form-label mb-1">{{ _('Champ') }}</label>
          <select id="rp-filter-field" class="form-select form-select-sm"></select>
        </div>
        <div class="col-6">
          <label class="form-label mb-1">{{ _('Opérateur') }}</label>
          <select id="rp-filter-op" class="form-select form-select-sm">
            <option value="eq">=</option>
            <option value="contains">contains</option>
            <option value="gt">&gt;</option>
            <option value="lt">&lt;</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label mb-1">{{ _('Valeur') }}</label>
          <input id="rp-filter-value" class="form-control form-control-sm" type="text" placeholder="value" />
        </div>
        <div class="col-12 d-flex flex-wrap gap-2">
          <button class="btn btn-outline-primary btn-sm" id="rp-add-filter">{{ _('Adicionar filtro') }}</button>
          <button class="btn btn-outline-secondary btn-sm" id="rp-clear-filters">{{ _('Limpar filtros') }}</button>
        </div>
      </div>
      <div id="rp-filter-summary" class="mt-2"><em>(sem filtros)</em></div>
    </div>
  </div>

</div>
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script>
    window.onReady(function(){
      const panel = document.getElementById('rp-floating-filters');
      if (!panel) return;

      const reportId = {{ report.id }};
      const filtersStorageKey = 'rp.filters.' + reportId;
      const state = { filters: [] };
      const keyCollapsed = 'rp.filters.collapsed';
      const toggleBtn = document.getElementById('rp-floating-filters-toggle');
      const collapseBtn = document.getElementById('rp-floating-filters-collapse');
      const dockBtn = document.getElementById('rp-floating-filters-dock');
      const head = document.getElementById('rp-floating-filters-head');
      const fieldEl = document.getElementById('rp-filter-field');
      const opEl = document.getElementById('rp-filter-op');
      const valueEl = document.getElementById('rp-filter-value');
      const addBtn = document.getElementById('rp-add-filter');
      const clearBtn = document.getElementById('rp-clear-filters');
      const summary = document.getElementById('rp-filter-summary');

      try {
        const rawFilters = localStorage.getItem(filtersStorageKey);
        const parsedFilters = rawFilters ? JSON.parse(rawFilters) : null;
        if (parsedFilters && Array.isArray(parsedFilters.filters)) {
          state.filters = parsedFilters.filters;
        }
      } catch (e) {}

      function persistFilters(){
        try { localStorage.setItem(filtersStorageKey, JSON.stringify({ filters: state.filters || [] })); } catch (e) {}
      }

      function setCollapsed(on){
        panel.classList.toggle('is-collapsed', !!on);
        try { localStorage.setItem(keyCollapsed, on ? '1' : '0'); } catch (e) {}
        const icon = collapseBtn ? collapseBtn.querySelector('i') : null;
        if (icon) icon.className = on ? 'bi bi-chevron-up' : 'bi bi-chevron-down';
      }

      function dockDefault(){
        panel.style.left = '';
        panel.style.top = '';
        panel.style.right = '18px';
      }

      function toNum(v){
        const n = Number(String(v).replace(',', '.'));
        return Number.isFinite(n) ? n : null;
      }

      function matchValue(cell, op, val){
        const a = String(cell == null ? '' : cell).toLowerCase();
        const b = String(val == null ? '' : val).toLowerCase();
        if (op === 'contains') return a.indexOf(b) !== -1;
        if (op === 'eq') return a === b;
        if (op === 'gt' || op === 'lt') {
          const an = toNum(a);
          const bn = toNum(b);
          if (an == null || bn == null) return false;
          return op === 'gt' ? an > bn : an < bn;
        }
        return true;
      }

      function buildFields(){
        const names = new Set();
        document.querySelectorAll('table thead th').forEach(function(th){
          const name = (th.textContent || '').trim();
          if (name) names.add(name);
        });
        document.querySelectorAll('[data-rp-field]').forEach(function(el){
          const name = (el.getAttribute('data-rp-field') || '').trim();
          if (name) names.add(name);
        });
        if (!fieldEl) return;
        const options = Array.from(names).map(function(name){
          return '<option value="' + name.replace(/"/g, '&quot;') + '">' + name + '</option>';
        }).join('');
        fieldEl.innerHTML = '<option value="">--</option>' + options;
        if (!options) {
          fieldEl.innerHTML = '<option value="">(aucun champ)</option>';
        }
      }

      function renderSummary(){
        if (!summary) return;
        if (!state.filters.length) {
          summary.innerHTML = '<em>(sem filtros)</em>';
          return;
        }
        summary.innerHTML = state.filters.map(function(f, idx){
          return '<span style="display:inline-block;margin:0 .4em .4em 0;padding:.2em .5em;border:1px solid #ddd;border-radius:6px;">'
            + f.field + ' ' + f.op + ' ' + String(f.value)
            + ' <a href="#" data-rm="' + idx + '" style="margin-left:.5em;">×</a></span>';
        }).join('');
        summary.querySelectorAll('a[data-rm]').forEach(function(a){
          a.addEventListener('click', function(e){
            e.preventDefault();
            const idx = Number(a.getAttribute('data-rm') || -1);
            if (idx < 0) return;
            state.filters.splice(idx, 1);
            persistFilters();
            renderSummary();
            applyFilters();
          });
        });
      }

      function applyFilters(){
        const fs = state.filters || [];

        document.querySelectorAll('[data-rp-field]').forEach(function(el){
          const fname = String(el.getAttribute('data-rp-field') || '').trim().toLowerCase();
          const fval = String(el.getAttribute('data-rp-value') || '');
          let ok = true;
          for (const f of fs) {
            const target = String(f.field || '').trim().toLowerCase();
            if (!target || target !== fname) continue;
            if (!matchValue(fval, f.op, f.value)) {
              ok = false;
              break;
            }
          }
          el.style.display = ok ? '' : 'none';
        });

        document.querySelectorAll('table').forEach(function(table){
          const headers = Array.from(table.querySelectorAll('thead th')).map(function(th){
            return (th.textContent || '').trim().toLowerCase();
          });
          const rows = table.querySelectorAll('tbody tr');
          rows.forEach(function(tr){
            let ok = true;
            for (const f of fs) {
              const idx = headers.indexOf(String(f.field || '').trim().toLowerCase());
              if (idx < 0) continue;
              const td = tr.children[idx];
              const cell = td ? td.textContent : '';
              if (!matchValue(cell, f.op, f.value)) {
                ok = false;
                break;
              }
            }
            tr.style.display = ok ? '' : 'none';
          });
          if (typeof table._rpRender === 'function') table._rpRender();
        });
      }

      if (toggleBtn) {
        toggleBtn.addEventListener('click', function(e){
          e.preventDefault();
          panel.style.display = panel.style.display === 'none' ? '' : 'none';
        });
      }
      if (collapseBtn) {
        collapseBtn.addEventListener('click', function(e){
          e.preventDefault();
          setCollapsed(!panel.classList.contains('is-collapsed'));
        });
      }
      if (dockBtn) {
        dockBtn.addEventListener('click', function(e){
          e.preventDefault();
          dockDefault();
        });
      }

      if (addBtn) {
        addBtn.addEventListener('click', function(e){
          e.preventDefault();
          const field = fieldEl ? fieldEl.value : '';
          const op = opEl ? opEl.value : 'eq';
          const value = valueEl ? valueEl.value : '';
          if (!field || String(value).trim() === '') return;
          state.filters.push({ field: field, op: op, value: value });
          persistFilters();
          renderSummary();
          applyFilters();
        });
      }
      if (clearBtn) {
        clearBtn.addEventListener('click', function(e){
          e.preventDefault();
          state.filters = [];
          persistFilters();
          renderSummary();
          applyFilters();
        });
      }

      function enhanceTable(table, idx){
        const headers = Array.from(table.querySelectorAll('thead th'));
        if (!headers.length) return;

        const allRows = Array.from(table.querySelectorAll('tbody tr'));
        let sortIndex = -1;
        let sortDir = 'asc';
        let page = 1;
        let pageSize = 25;
        const allowed = [10, 25, 50, 100, -1];
        const stateKey = 'rp.table.' + reportId + '.' + idx;

        try {
          const raw = localStorage.getItem(stateKey);
          const saved = raw ? JSON.parse(raw) : null;
          if (saved && typeof saved === 'object') {
            if (Number.isInteger(saved.sortIndex)) sortIndex = saved.sortIndex;
            if (saved.sortDir === 'asc' || saved.sortDir === 'desc') sortDir = saved.sortDir;
            if (Number.isInteger(saved.page) && saved.page > 0) page = saved.page;
            if (allowed.includes(Number(saved.pageSize))) pageSize = Number(saved.pageSize);
          }
        } catch (e) {}

        function persist(){
          try { localStorage.setItem(stateKey, JSON.stringify({ sortIndex, sortDir, page, pageSize })); } catch (e) {}
        }

        function parseNum(v){
          const n = Number(String(v == null ? '' : v).replace(',', '.'));
          return Number.isFinite(n) ? n : null;
        }

        function cmp(a, b){
          const an = parseNum(a);
          const bn = parseNum(b);
          if (an != null && bn != null) return an - bn;
          return String(a == null ? '' : a).localeCompare(String(b == null ? '' : b), undefined, { numeric: true, sensitivity: 'base' });
        }

        const wrap = table.closest('.table-responsive') || table.parentElement;
        const toolbar = document.createElement('div');
        toolbar.className = 'd-flex align-items-center justify-content-between flex-wrap gap-2 mb-2';
        wrap.insertBefore(toolbar, table);

        const pager = document.createElement('div');
        pager.className = 'd-flex align-items-center justify-content-between flex-wrap gap-2 mt-2';
        wrap.appendChild(pager);

        function render(){
          let rows = allRows.slice();
          const fs = state.filters || [];
          if (fs.length) {
            rows = rows.filter(function(tr){
              const rowCells = Array.from(tr.children);
              for (const f of fs) {
                const hidx = headers.findIndex(th => (th.textContent || '').trim().toLowerCase() === String(f.field || '').trim().toLowerCase());
                if (hidx < 0) continue;
                const cell = rowCells[hidx] ? rowCells[hidx].textContent : '';
                if (!matchValue(cell, f.op, f.value)) return false;
              }
              return true;
            });
          }

          if (sortIndex >= 0 && sortIndex < headers.length) {
            rows.sort((ra, rb) => {
              const va = ra.children[sortIndex] ? ra.children[sortIndex].textContent : '';
              const vb = rb.children[sortIndex] ? rb.children[sortIndex].textContent : '';
              return cmp(va, vb);
            });
            if (sortDir === 'desc') rows.reverse();
          }

          const total = rows.length;
          const totalPages = pageSize === -1 ? 1 : Math.max(1, Math.ceil(total / pageSize));
          if (page > totalPages) page = totalPages;
          if (page < 1) page = 1;
          const start = pageSize === -1 ? 0 : (page - 1) * pageSize;
          const end = pageSize === -1 ? total : Math.min(total, start + pageSize);
          const pageRows = rows.slice(start, end);

          headers.forEach((th, hidx) => {
            let icon = '';
            if (sortIndex === hidx) icon = sortDir === 'asc' ? ' ▲' : ' ▼';
            th.style.cursor = 'pointer';
            const base = (th.getAttribute('data-rp-base') || th.textContent || '').replace(/[\u25B2\u25BC]\s*$/, '').trim();
            th.setAttribute('data-rp-base', base);
            th.textContent = base + icon;
            if (!th._rpBound) {
              th._rpBound = true;
              th.addEventListener('click', function(){
                if (sortIndex === hidx) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
                else { sortIndex = hidx; sortDir = 'asc'; }
                page = 1;
                persist();
                render();
              });
            }
          });

          const tbody = table.querySelector('tbody');
          if (!tbody) return;
          tbody.innerHTML = '';
          pageRows.forEach(r => tbody.appendChild(r));

          toolbar.innerHTML =
            '<div class="small text-secondary">' + total + ' lignes</div>' +
            '<div class="d-flex align-items-center gap-2"><label class="small text-secondary mb-0">Taille de page</label>' +
            '<select class="form-select form-select-sm" data-rp-pagesize style="width:auto;">' +
            allowed.map(function(ps){
              const lbl = ps === -1 ? 'Tout' : String(ps);
              return '<option value="' + ps + '"' + (ps === pageSize ? ' selected' : '') + '>' + lbl + '</option>';
            }).join('') +
            '</select></div>';

          pager.innerHTML =
            '<div class="small text-secondary">' + (total === 0 ? '0' : (start + 1)) + '-' + end + ' / ' + total + '</div>' +
            '<div class="btn-group btn-group-sm" role="group">' +
            '<button type="button" class="btn btn-outline-secondary" data-rp-page="prev"' + (page <= 1 ? ' disabled' : '') + '>Précédent</button>' +
            '<button type="button" class="btn btn-outline-secondary" disabled>' + page + '/' + totalPages + '</button>' +
            '<button type="button" class="btn btn-outline-secondary" data-rp-page="next"' + (page >= totalPages ? ' disabled' : '') + '>Suivant</button>' +
            '</div>';

          const pageSizeSel = toolbar.querySelector('[data-rp-pagesize]');
          if (pageSizeSel) {
            pageSizeSel.addEventListener('change', function(){
              const v = Number(pageSizeSel.value);
              pageSize = allowed.includes(v) ? v : 25;
              page = 1;
              persist();
              render();
            });
          }
          const prev = pager.querySelector('button[data-rp-page="prev"]');
          const next = pager.querySelector('button[data-rp-page="next"]');
          if (prev) prev.addEventListener('click', function(){ page = Math.max(1, page - 1); persist(); render(); });
          if (next) next.addEventListener('click', function(){ page = Math.min(totalPages, page + 1); persist(); render(); });
        }

        table._rpRender = render;
        render();
      }

      try { setCollapsed(localStorage.getItem(keyCollapsed) === '1'); } catch (e) { setCollapsed(false); }

      if (head) {
        let dragging = false;
        let startX = 0;
        let startY = 0;
        let origLeft = 0;
        let origTop = 0;

        function onMove(clientX, clientY){
          if (!dragging) return;
          const dx = clientX - startX;
          const dy = clientY - startY;
          const w = panel.offsetWidth || 320;
          const h = panel.offsetHeight || 180;
          const maxLeft = Math.max(8, window.innerWidth - w - 8);
          const maxTop = Math.max(8, window.innerHeight - h - 8);
          let nextLeft = origLeft + dx;
          let nextTop = origTop + dy;
          nextLeft = Math.max(8, Math.min(maxLeft, nextLeft));
          nextTop = Math.max(8, Math.min(maxTop, nextTop));
          panel.style.left = nextLeft + 'px';
          panel.style.top = nextTop + 'px';
          panel.style.right = 'auto';
        }

        function stopDrag(){
          dragging = false;
          document.body.classList.remove('user-select-none');
        }

        head.addEventListener('mousedown', function(e){
          if (window.matchMedia('(max-width: 991.98px)').matches) return;
          if (e.button !== 0) return;
          if (e.target && e.target.closest('button,input,select,textarea,a,label')) return;
          const rect = panel.getBoundingClientRect();
          dragging = true;
          startX = e.clientX;
          startY = e.clientY;
          origLeft = rect.left;
          origTop = rect.top;
          document.body.classList.add('user-select-none');
          e.preventDefault();
        });
        document.addEventListener('mousemove', function(e){ onMove(e.clientX, e.clientY); });
        document.addEventListener('mouseup', stopDrag);
      }

      buildFields();
      renderSummary();
      document.querySelectorAll('table').forEach(function(tbl, i){ enhanceTable(tbl, i); });
      applyFilters();
      document.querySelectorAll('table').forEach(function(tbl){ if (typeof tbl._rpRender === 'function') tbl._rpRender(); });
    });
  </script>
{% endblock %}
