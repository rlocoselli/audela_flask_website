{% extends "portal/layout.html" %}
{% set title = report.name %}

{% block portal_content %}
<div class="container-fluid px-0">

  <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">{{ report.name }}</h1>
      <div class="text-secondary small"><i class="bi bi-database me-1"></i>{{ source.name }} ({{ source.type }})</div>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('portal.report_builder', report_id=report.id) }}">
        <i class="bi bi-pencil"></i> {{ _('Editar') }}
      </a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('portal.reports_list') }}">
        <i class="bi bi-arrow-left"></i> {{ _('Voltar') }}
      </a>
      <a class="btn btn-primary btn-sm" href="{{ url_for('portal.report_pdf', report_id=report.id) }}">
        <i class="bi bi-filetype-pdf"></i> {{ _('Exportar PDF') }}
      </a>
    </div>
  </div>

  {% set sections = (layout.sections or layout.get('sections') or {}) %}

  <div class="card border-0 shadow-sm rounded-4 mb-3">
    <div class="card-body">
      <div class="row g-4">
        {% for sec_name in ['header','body','footer'] %}
          {% set blocks = sections.get(sec_name) or [] %}
          <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-semibold text-uppercase small text-secondary">{{ sec_name }}</div>
            </div>

            {% if not blocks %}
              <div class="text-secondary small">{{ _('Sem blocos.') }}</div>
            {% else %}
              <div class="d-grid gap-3">
                {% for b in blocks %}
                  {% set btype = (b.type or b.get('type') or '') %}
                  {% if btype in ['text','markdown'] %}
                    <div class="border rounded-4 p-3 bg-body">
                      {% if b.title or b.get('title') %}
                        <div class="fw-semibold mb-1">{{ b.title or b.get('title') }}</div>
                      {% endif %}
                      <div class="text-secondary" style="white-space: pre-wrap;">{{ b.content or b.get('content') }}</div>
                    </div>
                  {% elif btype == 'question' %}
                    {% set qid = (b.question_id or b.get('question_id') or 0)|int %}
                    {% set q = questions.get(qid) %}
                    {% set d = blocks_data.get(qid) %}
                    <div class="border rounded-4 p-3 bg-body">
                      <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                        <div class="fw-semibold"><i class="bi bi-ui-checks me-1"></i>{{ q.name if q else ('Pergunta #' ~ qid) }}</div>
                        <span class="badge text-bg-light border">{{ _('Tabela') }}</span>
                      </div>
                      {% if d and d.error %}
                        <div class="alert alert-danger py-2 mb-0">{{ d.error }}</div>
                      {% elif d and d.rows %}
                        <div class="table-responsive">
                          <table class="table table-sm align-middle mb-0">
                            <thead>
                              <tr>
                                {% for c in d.columns %}<th>{{ c }}</th>{% endfor %}
                              </tr>
                            </thead>
                            <tbody>
                              {% for r in d.rows %}
                                <tr>
                                  {% for cell in r %}<td>{{ cell }}</td>{% endfor %}
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      {% else %}
                        <div class="text-secondary small">{{ _('Sem linhas retornadas.') }}</div>
                      {% endif %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

</div>
{% endblock %}
