{% extends "portal/layout.html" %}
{% set title = _('Editor SQL') %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css" />
  <style>
    .bi-panel { border:1px solid #e6e6e6; border-radius: 10px; padding: 1em; }
    .bi-schema { max-height: 520px; overflow:auto; }
    .bi-schema .tbl { margin:.3em 0; }
    .bi-schema .cols { margin:.2em 0 0 1em; font-size:.9em; color:#444; }
    .bi-schema button.btn-link{ text-decoration:none; color: inherit; }
    .bi-schema button.btn-link:hover{ text-decoration:underline; }
    .CodeMirror { height: 360px; border:1px solid #e6e6e6; border-radius: 10px; }
  </style>
{% endblock %}

{% block portal_content %}
  <div class="box">
    <h3>{{ _('Editor SQL') }}</h3>
    <p style="margin:0;">{{ _('Execute consultas ad-hoc, com autocomplete, Query Builder e linguagem humana.') }}</p>
  </div>

  <div class="row gtr-uniform gtr-50">
    <div class="col-8 col-12-medium">
      <div class="box">
        <form method="post" id="sql-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

          <div class="row gtr-uniform gtr-50">
            <div class="col-12">
              <label>{{ _('Fonte de dados') }}</label>
              <select name="source_id" id="source_id" required>
                <option value="">--</option>
                {% for s in sources %}
                  <option value="{{ s.id }}" data-dbtype="{{ s.type }}">{{ s.name }} ({{ s.type }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12">
              <label>{{ _('Linguagem humana') }}</label>
              <div style="display:flex; gap:.6em; flex-wrap:wrap; align-items:center;">
                <input type="text" id="nlq-text" placeholder="ex: total vendas por mês" style="flex:1; min-width: 260px;" />
                <a href="#" class="button" id="nlq-generate">{{ _('Gerar SQL') }}</a>
              </div>
              <div id="nlq-warnings" style="margin-top:.4em; font-size:.9em;"></div>
            </div>

            <div class="col-12" id="builder">
              <details>
                <summary style="cursor:pointer;"><strong>{{ _('Query Builder') }}</strong> — {{ _('montar SELECT com ajuda da estrutura') }}</summary>
                <div class="bi-panel" style="margin-top:.8em;">
                  <div class="row gtr-uniform gtr-50">
                    <div class="col-6 col-12-small">
                      <label>{{ _('Tabela') }}</label>
                      <select id="qb-table"><option value="">--</option></select>
                    </div>
                    <div class="col-6 col-12-small">
                      <label>{{ _('Limite') }}</label>
                      <input id="qb-limit" type="number" value="100" min="1" max="5000" />
                    </div>
                    <div class="col-12">
                      <label>{{ _('Colunas') }}</label>
                      <div id="qb-columns" style="display:flex; flex-wrap:wrap; gap:.6em;"></div>
                    </div>
                    <div class="col-12">
                      <label>{{ _('Filtros') }}</label>
                      <div style="display:flex; gap:.6em; flex-wrap:wrap; align-items:center;">
                        <select id="qb-filter-field" style="min-width: 180px;"></select>
                        <select id="qb-filter-op" style="min-width: 140px;">
                          <option value="=">=</option>
                          <option value="!=">!=</option>
                          <option value=">">&gt;</option>
                          <option value="<">&lt;</option>
                          <option value="LIKE">LIKE</option>
                        </select>
                        <input id="qb-filter-value" type="text" placeholder="value" style="min-width: 180px;" />
                        <a href="#" class="button small" id="qb-add-filter">{{ _('Adicionar filtro') }}</a>
                      </div>
                      <div id="qb-filter-list" style="margin-top:.6em;"></div>
                    </div>
                    <div class="col-12">
                      <a href="#" class="button primary" id="qb-generate">{{ _('Gerar SQL no editor') }}</a>
                    </div>
                  </div>
                </div>
              </details>
            </div>

            <div class="col-12">
              <label>SQL</label>
              <textarea name="sql_text" id="sql_text" rows="10" placeholder="SELECT ..."></textarea>
            </div>

            <div class="col-12">
              <label>{{ _('Parâmetros (JSON)') }}</label>
              <textarea name="params_json" id="params_json" rows="6" placeholder='{"start_date": "2026-01-01", "end_date": "2026-02-01"}'></textarea>
              <p style="margin:.4em 0 0 0; font-size:.9em;"><em>{{ _('Use :nome_param no SQL e preencha valores aqui. tenant_id é aplicado automaticamente.') }}</em></p>
            </div>

            <div class="col-12">
              <button type="submit" class="button primary">{{ _('Executar') }}</button>
            </div>
          </div>
        </form>
      </div>

      {% if error %}
        <div class="box">
          <h3>{{ _('Erro') }}</h3>
          <pre style="white-space: pre-wrap;">{{ error }}</pre>
        </div>
      {% endif %}

      {% if result %}
        <div class="box">
          <h3>{{ _('Resultado') }}{% if elapsed_ms %} ({{ elapsed_ms }} ms){% endif %}</h3>
          {% if result.columns %}
            <div id="ad-hoc-viz" style="min-height: 420px;"></div>
            <p style="margin-top:.6em;">
              <a class="button" href="#" id="adhoc-export-pdf">{{ _('Exportar PDF') }}</a>
              <em style="margin-left:.7em;">{{ _('Linhas retornadas') }}: {{ result.rows|length }}</em>
            </p>
            <script type="application/json" id="adhoc-data">{{ result|tojson }}</script>
          {% else %}
            <p>{{ _('Sem linhas retornadas.') }}</p>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <div class="col-4 col-12-medium">
      <div class="box">
        <h4>{{ _('Estrutura') }}</h4>
        <p style="margin-top:0; font-size:.95em;">{{ _('Escolha uma fonte para ver tabelas e colunas (autocomplete).') }}</p>
        <div class="bi-schema" id="schema"></div>
      </div>
    </div>
  </div>
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/sql-hint.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="{{ url_for('static', filename='bi/bi_viz.js') }}"></script>
  <script src="{{ url_for('static', filename='bi/bi_editor.js') }}"></script>

  {% if result and result.columns %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dataEl = document.getElementById('adhoc-data');
      const container = document.getElementById('ad-hoc-viz');
      if (dataEl && container && window.BI && BI.renderViz) {
        let data = {};
        try { data = JSON.parse(dataEl.textContent); } catch (e) {}
        BI.renderViz(container, data, { type: 'table' }, null);
        const btn = document.getElementById('adhoc-export-pdf');
        if (btn) {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            await BI.exportPdf('SQL Export', data);
          });
        }
      }
    });
  </script>
  {% endif %}
{% endblock %}
