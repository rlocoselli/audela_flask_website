{% extends "portal/layout.html" %}
{% set title = _('Chat IA') %}

{% block portal_content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">{{ _('Chat IA') }}</h1>
    <div class="text-secondary">{{ _('Pergunte sobre os dados') }}</div>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-4">
    <div class="card border-0 shadow-sm" style="border-radius: 1rem;">
      <div class="card-body">
        <label class="form-label">{{ _('Selecione uma pergunta') }}</label>
        <select class="form-select" id="ai-question">
          <option value="">--</option>
          {% for q in questions %}
            <option value="{{ q.id }}">{{ q.name }}</option>
          {% endfor %}
        </select>

        <div class="mt-3">
          <label class="form-label">{{ _('Parâmetros (JSON)') }}</label>
          <textarea class="form-control" id="ai-params" rows="6" placeholder="{\n  \"from\": \"2025-01-01\"\n}"></textarea>
          <div class="form-text">{{ _('Use :nome_param no SQL e preencha valores aqui. tenant_id é aplicado automaticamente.') }}</div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-secondary" id="ai-clear"><i class="bi bi-trash"></i> {{ _('Limpar chat') }}</button>
          <button class="btn btn-outline-secondary" id="ai-theme" type="button" onclick="__toggleTheme()"><i class="bi bi-moon-stars"></i> {{ _('Tema') }}</button>
        </div>

        <hr class="my-3" />
        <div class="small text-secondary">
          <div><strong>OpenAI</strong>: configure <code>OPENAI_API_KEY</code> no servidor.</div>
          <div>Opcional: <code>OPENAI_MODEL</code> e <code>OPENAI_BASE_URL</code>.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-8">
    <div class="chat-log" id="ai-log"></div>

    <div class="mt-3">
      <div class="input-group">
        <input class="form-control" id="ai-input" type="text" placeholder="{{ _('Mensagem') }}" />
        <button class="btn btn-primary" id="ai-send"><i class="bi bi-send"></i> {{ _('Enviar') }}</button>
      </div>
      <div class="form-text" id="ai-status"></div>
    </div>

    <div class="mt-3 d-none" id="ai-charts"></div>
  </div>
</div>
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='bi/ai_chat.js') }}"></script>
{% endblock %}
