{% extends "portal/layout.html" %}
{% set title = _('Dashboard') %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>
  <style>
    .bi-viz table { width: 100%; border-collapse: collapse; }
    .bi-viz th, .bi-viz td { border: 1px solid #e6e6e6; padding: .35em .45em; font-size: .9em; }
  </style>
{% endblock %}

{% block portal_content %}
  <div class="box">
    <h3>{{ dashboard.name }}</h3>
    {% if dashboard.description %}<p>{{ dashboard.description }}</p>{% endif %}

    <div class="row gtr-uniform gtr-50" style="align-items:flex-end;">
      <div class="col-12">
        <label>{{ _('Filtros') }}</label>
        <div style="display:flex; gap:.6em; flex-wrap:wrap; align-items:center;">
          <select id="bi-filter-field" style="min-width: 180px;"></select>
          <select id="bi-filter-op" style="min-width: 140px;">
            <option value="eq">=</option>
            <option value="contains">contains</option>
            <option value="gt">&gt;</option>
            <option value="lt">&lt;</option>
          </select>
          <input id="bi-filter-value" type="text" placeholder="value" style="min-width: 180px;" />
          <a href="#" id="bi-add-filter" class="button small">{{ _('Adicionar filtro') }}</a>
          <a href="#" id="bi-clear-filters" class="button small">{{ _('Limpar filtros') }}</a>
          <a href="#" id="bi-export-pdf" class="button small">{{ _('Exportar PDF') }}</a>
        </div>
        <div id="bi-filter-summary" style="margin-top:.6em;"></div>
      </div>
    </div>
  </div>

  {% if not cards %}
    <div class="box">
      <p>{{ _('Nenhum card ainda. Crie um dashboard escolhendo perguntas.') }}</p>
    </div>
  {% endif %}

  {% for item in cards %}
    <div class="box" data-bi-card="1" data-card-id="{{ item.card.id }}">
      <h4 style="margin-bottom:.4em;">{{ item.question.name }}</h4>
      {% if item.result.error %}
        <p style="color:#b00;">{{ _('Erro') }}: {{ item.result.error }}</p>
      {% endif %}
      <div class="bi-viz" style="min-height: 420px;" id="viz-{{ item.card.id }}"></div>
      <p style="margin-top:.8em;">
        <a class="button small" href="{{ url_for('portal.questions_viz', question_id=item.question.id) }}">{{ _('Configurar visualização') }}</a>
      </p>
      <script type="application/json" id="data-{{ item.card.id }}">{{ item.result|tojson }}</script>
      <script type="application/json" id="cfg-{{ item.card.id }}">{{ item.viz_config|tojson }}</script>
    </div>
  {% endfor %}
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='bi/bi_viz.js') }}"></script>
{% endblock %}
