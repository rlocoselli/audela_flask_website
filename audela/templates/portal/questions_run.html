{% extends "portal/layout.html" %}
{% set title = _('Executar pergunta') %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>
{% endblock %}

{% block portal_content %}
  <div class="box">
    <h3>{{ question.name }}</h3>
    <p><strong>Fonte:</strong> {{ source.name }}</p>
    <p>
      <a class="button" href="{{ url_for('portal.questions_view', question_id=question.id) }}">{{ _('Voltar') }}</a>
      {% if result and result.columns %}
        <a class="button" href="#" id="export-pdf">{{ _('Exportar PDF') }}</a>
      {% endif %}
    </p>
  </div>

  {% if error %}
    <div class="box">
      <h3>{{ _('Erro') }}</h3>
      <pre style="white-space: pre-wrap;">{{ error }}</pre>
    </div>
  {% endif %}

  {% if result %}
    <div class="box">
      <h3>{{ _('Resultado') }}{% if elapsed_ms %} ({{ elapsed_ms }} ms){% endif %}</h3>
      {% if result.columns %}
        <div id="run-viz" style="min-height: 420px;"></div>
        <p style="margin-top:.6em;"><em>{{ _('Linhas retornadas') }}:</em> {{ result.rows|length }}</p>
      {% else %}
        <p>{{ _('Sem linhas retornadas.') }}</p>
      {% endif %}
    </div>
    <script type="application/json" id="run-data">{{ result|tojson }}</script>
    <script type="application/json" id="run-cfg">{{ viz_config|tojson }}</script>
  {% endif %}
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='bi/bi_viz.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dataEl = document.getElementById('run-data');
      const cfgEl = document.getElementById('run-cfg');
      const container = document.getElementById('run-viz');
      if (dataEl && cfgEl && container && window.BI && BI.renderViz) {
        let data = {};
        let cfg = {};
        try { data = JSON.parse(dataEl.textContent); } catch (e) {}
        try { cfg = JSON.parse(cfgEl.textContent); } catch (e) {}
        BI.renderViz(container, data, cfg, null);
        const btn = document.getElementById('export-pdf');
        if (btn) {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            await BI.exportPdf('{{ question.name|e }}', data);
          });
        }
      }
    });
  </script>
{% endblock %}
