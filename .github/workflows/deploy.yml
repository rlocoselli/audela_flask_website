name: Deploy Flask App (root)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: audeladesdonnees

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH as root
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}

          script: |
            set -e
            echo "üöÄ Deploy started (root)"

            cd /root/audela_flask_website

            echo "üì• Git pull"
            git reset --hard
            git pull origin main

            echo "üîß Run install"
            chmod +x install.sh
            ./install.sh \
              "${{ secrets.HOST }}" \
              "${{ secrets.USER }}" \
              "${{ secrets.PASSWORD }}" \
              "${{ secrets.OPENAI_API_KEY }}" \
              "${{ secrets.DB_NAME }}" \
              "${{ secrets.DB_PORT }}" \
              "${{ secrets.DATABASE_URL }}" \
              "${{ secrets.MAIL_SERVER }}" \
              "${{ secrets.MAIL_PORT }}" \
              "${{ secrets.MAIL_USE_TLS }}" \
              "${{ secrets.MAIL_USE_SSL }}" \
              "${{ secrets.MAIL_USERNAME }}" \
              "${{ secrets.MAIL_PASSWORD }}" \
              "${{ secrets.MAIL_DEFAULT_SENDER }}"

            echo "üóÉÔ∏è Apply DB migrations"
            # RUN_MIGRATIONS=1 is already set on container startup; this explicit step
            # guarantees latest schema after deploy.
            COMPOSE_CMD="docker compose"
            if ! docker compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker-compose"
            fi

            # Wait until app container is ready for exec
            for i in $(seq 1 20); do
              if $COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml ps audela >/dev/null 2>&1; then
                if $COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml exec -T audela sh -lc "echo ready" >/dev/null 2>&1; then
                  break
                fi
              fi
              echo "‚è≥ Waiting audela container... ($i/20)"
              sleep 3
            done

            # Pre-fix: if known tables already exist, mark corresponding migrations as applied.
            pre_stamp_if_exists () {
              local tbl="$1"
              local rev="$2"
              local exists
              exists="$($COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml exec -T audela python -c "from sqlalchemy import text; from audela import create_app; from audela.extensions import db; app=create_app(); ctx=app.app_context(); ctx.push(); e=db.session.execute(text(\"SELECT to_regclass('public.${tbl}')\")).scalar(); print('1' if e else '0'); ctx.pop()" 2>/dev/null || echo 0)"
              if [ "$exists" = "1" ]; then
                echo "‚ÑπÔ∏è ${tbl} exists -> pre-stamp ${rev}"
                $COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml exec -T audela flask db stamp "$rev" || true
              fi
            }

            pre_stamp_if_exists project_workspaces 20260220_add_project_workspaces
            pre_stamp_if_exists finance_investments 20260221_add_finance_investments
            pre_stamp_if_exists finance_accounting_periods 20260221_add_finance_accounting_periods

            # Retry migrations to handle transient startup race conditions
            MIG_OK=0
            for i in $(seq 1 5); do
              echo "üß≠ Alembic heads (attempt $i):"
              $COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml exec -T audela flask db heads || true

              set +e
              MIG_OUT="$($COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml exec -T audela flask db upgrade 2>&1)"
              MIG_RC=$?
              set -e

              if [ "$MIG_RC" -eq 0 ]; then
                echo "$MIG_OUT"
                MIG_OK=1
                break
              fi
              echo "$MIG_OUT"

              if echo "$MIG_OUT" | grep -Eqi "DuplicateTable|already exists"; then
                if echo "$MIG_OUT" | grep -Eqi "project_workspaces"; then
                  echo "‚ö†Ô∏è project_workspaces already exists -> stamping migration 20260220_add_project_workspaces"
                  $COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml exec -T audela flask db stamp 20260220_add_project_workspaces || true
                elif echo "$MIG_OUT" | grep -Eqi "finance_investments"; then
                  echo "‚ö†Ô∏è finance_investments already exists -> stamping migration 20260221_add_finance_investments"
                  $COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml exec -T audela flask db stamp 20260221_add_finance_investments || true
                elif echo "$MIG_OUT" | grep -Eqi "finance_accounting_periods"; then
                  echo "‚ö†Ô∏è finance_accounting_periods already exists -> stamping migration 20260221_add_finance_accounting_periods"
                  $COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml exec -T audela flask db stamp 20260221_add_finance_accounting_periods || true
                fi
                if $COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml exec -T audela flask db upgrade heads; then
                  MIG_OK=1
                  break
                fi
              fi

              # Fallback for temporary multi-head situations
              if $COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml exec -T audela flask db upgrade heads; then
                MIG_OK=1
                break
              fi

              echo "‚ö†Ô∏è Migration attempt $i failed, retrying..."
              sleep 4
            done

            if [ "$MIG_OK" -ne 1 ]; then
              echo "‚ùå Migration failed after retries"
              exit 1
            fi

            echo "üîé Verify migration objects"
            $COMPOSE_CMD -f docker-compose.yml -f docker-compose.letsencrypt.yml exec -T audela python -c "from sqlalchemy import text; from audela import create_app; from audela.extensions import db; app=create_app(); ctx=app.app_context(); ctx.push(); exists=db.session.execute(text(\"SELECT to_regclass('public.finance_accounting_periods')\")).scalar(); assert exists, 'finance_accounting_periods table not found'; print('finance_accounting_periods table found:', exists); ctx.pop()"

            echo "üîÑ Restart service"
            systemctl restart audeladedonnees

            echo "‚úÖ Deploy completed"